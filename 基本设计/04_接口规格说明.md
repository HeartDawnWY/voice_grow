# VoiceGrow 接口规格说明

> 版本: v1.0
> 更新日期: 2026-01-12

---

## 1. 接口概述

### 1.1 通信协议

| 接口类型 | 协议 | 用途 |
|---------|------|-----|
| 语音交互 | WebSocket | 实时语音数据传输与响应 |
| 内容管理 | HTTP REST | 内容查询、元数据获取 |
| 音频文件 | HTTP | 音频文件下载/流式播放 |

### 1.2 基础URL

```
# 开发环境
WebSocket: ws://localhost:4399        # open-xiaoai 客户端连接
HTTP API:  http://localhost:8000/api  # 管理API
MinIO:     http://localhost:9000      # 对象存储

# 生产环境
WebSocket: ws://server-ip:4399
HTTP API:  https://voicegrow.example.com/api
MinIO:     http://minio-endpoint:9000
```

---

## 2. WebSocket接口

### 2.1 连接端点

```
ws://server:4399
```

> ⚠️ 使用 open-xiaoai 客户端，端口固定为 4399。消息格式需遵循 open-xiaoai 协议。

**查询参数:**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|-----|
| device_id | string | 是 | 设备唯一标识 |

### 2.2 消息格式

#### 2.2.1 客户端 → 服务端

**音频数据消息**
```json
{
    "type": "audio",
    "data": "<base64_encoded_audio>",
    "format": "wav",
    "sample_rate": 16000,
    "timestamp": 1704067200000
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|-----|
| type | string | 是 | 消息类型: "audio" |
| data | string | 是 | Base64编码的音频数据 |
| format | string | 是 | 音频格式: "wav", "pcm" |
| sample_rate | int | 是 | 采样率，通常为16000 |
| timestamp | int | 是 | 客户端时间戳(毫秒) |

**控制命令消息**
```json
{
    "type": "command",
    "action": "pause",
    "timestamp": 1704067200000
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|-----|
| type | string | 是 | 消息类型: "command" |
| action | string | 是 | 控制动作 |
| timestamp | int | 是 | 客户端时间戳 |

**支持的控制动作:**
- `pause` - 暂停播放
- `resume` - 继续播放
- `stop` - 停止播放
- `next` - 下一曲/下一个
- `previous` - 上一曲/上一个
- `volume_up` - 音量增加
- `volume_down` - 音量减少
- `heartbeat` - 心跳保活

#### 2.2.2 服务端 → 客户端

**识别结果消息**
```json
{
    "type": "recognition",
    "text": "讲个故事",
    "confidence": 0.95,
    "timestamp": 1704067200100
}
```

**响应消息**
```json
{
    "type": "response",
    "intent": "play_story",
    "text": "好的，现在为你播放《三只小猪》",
    "audio_url": "http://minio:9000/voicegrow-bucket/stories/fairy_tale/three_pigs.mp3?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=...",
    "tts_audio": "<base64_encoded_tts>",
    "action": null,
    "metadata": {
        "content_id": "story_001",
        "duration": 480
    },
    "timestamp": 1704067200500
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|-----|
| type | string | 是 | 消息类型: "response" |
| intent | string | 是 | 识别的意图 |
| text | string | 是 | 回复文本 |
| audio_url | string | 否 | MinIO预签名URL（有效期1小时） |
| tts_audio | string | 否 | TTS合成的Base64音频 |
| action | string | 否 | 控制动作指令 |
| metadata | object | 否 | 额外元数据 |
| timestamp | int | 是 | 服务端时间戳 |

**流式TTS消息**
```json
{
    "type": "tts_stream",
    "chunk_index": 0,
    "total_chunks": 5,
    "data": "<base64_audio_chunk>",
    "is_final": false,
    "timestamp": 1704067200200
}
```

**错误消息**
```json
{
    "type": "error",
    "code": "ASR_FAILED",
    "message": "语音识别失败，请重试",
    "timestamp": 1704067200100
}
```

**错误码:**

| 错误码 | 说明 |
|-------|-----|
| ASR_FAILED | 语音识别失败 |
| NLU_FAILED | 意图识别失败 |
| CONTENT_NOT_FOUND | 内容未找到 |
| TTS_FAILED | 语音合成失败 |
| LLM_FAILED | LLM服务失败 |
| RATE_LIMITED | 请求频率过高 |
| SERVER_ERROR | 服务器内部错误 |

**状态更新消息**
```json
{
    "type": "state",
    "state": "playing",
    "content": {
        "id": "story_001",
        "title": "三只小猪",
        "progress": 120
    },
    "timestamp": 1704067200600
}
```

### 2.3 交互流程示例

```
Client                              Server
   |                                   |
   |  1. 建立WebSocket连接             |
   |---------------------------------->|
   |                                   |
   |  2. 连接确认                      |
   |<----------------------------------|
   |  {"type":"connected",             |
   |   "session_id":"xxx"}             |
   |                                   |
   |  3. 发送音频数据                  |
   |---------------------------------->|
   |  {"type":"audio",                 |
   |   "data":"base64..."}             |
   |                                   |
   |  4. 返回识别结果（可选）          |
   |<----------------------------------|
   |  {"type":"recognition",           |
   |   "text":"讲个故事"}              |
   |                                   |
   |  5. 返回响应                      |
   |<----------------------------------|
   |  {"type":"response",              |
   |   "intent":"play_story",          |
   |   "text":"好的，为你播放...",     |
   |   "audio_url":"/api/audio/..."}   |
   |                                   |
   |  6. 心跳保活 (每30秒)             |
   |---------------------------------->|
   |  {"type":"command",               |
   |   "action":"heartbeat"}           |
   |                                   |
```

---

## 3. REST API接口

### 3.1 内容管理API

#### 3.1.1 获取内容列表

**请求:**
```http
GET /api/content?type={type}&category={category}&keyword={keyword}&page={page}&size={size}
```

**查询参数:**

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|-----|------|-----|-------|-----|
| type | string | 否 | - | 内容类型: story, music, english |
| category | string | 否 | - | 内容分类 |
| keyword | string | 否 | - | 搜索关键词 |
| page | int | 否 | 1 | 页码 |
| size | int | 否 | 20 | 每页数量 |

**响应:**
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "total": 150,
        "page": 1,
        "size": 20,
        "items": [
            {
                "id": 1,
                "type": "story",
                "category": "fairy_tale",
                "title": "三只小猪",
                "description": "经典童话故事",
                "duration": 480,
                "age_range": [3, 8],
                "tags": ["经典", "勇气"],
                "audio_url": "http://minio:9000/voicegrow-bucket/stories/fairy_tale/three_pigs.mp3?X-Amz-...",
                "cover_url": "http://minio:9000/voicegrow-bucket/covers/story_001.jpg?X-Amz-...",
                "play_count": 1234
            }
        ]
    }
}
```

> 注: `audio_url` 和 `cover_url` 为 MinIO 预签名URL，有效期默认1小时。

#### 3.1.2 获取单个内容详情

**请求:**
```http
GET /api/content/{content_id}
```

**响应:**
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "id": 1,
        "type": "story",
        "category": "fairy_tale",
        "title": "三只小猪",
        "description": "经典童话故事，讲述三只小猪建房子的故事...",
        "duration": 480,
        "age_range": [3, 8],
        "tags": ["经典", "勇气", "智慧"],
        "audio_url": "http://minio:9000/voicegrow-bucket/stories/fairy_tale/three_pigs.mp3?X-Amz-...",
        "cover_url": "http://minio:9000/voicegrow-bucket/covers/story_001.jpg?X-Amz-...",
        "play_count": 1234,
        "created_at": "2024-01-01T00:00:00Z"
    }
}
```

#### 3.1.3 获取随机内容

**请求:**
```http
GET /api/content/random?type={type}&category={category}
```

**响应:**
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "id": 42,
        "type": "story",
        "category": "bedtime",
        "title": "小红帽",
        "audio_url": "http://minio:9000/voicegrow-bucket/stories/bedtime/little_red.mp3?X-Amz-...",
        "duration": 360
    }
}
```

#### 3.1.4 获取内容分类

**请求:**
```http
GET /api/content/categories?type={type}
```

**响应:**
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "type": "story",
        "categories": [
            {
                "code": "bedtime",
                "name": "睡前故事",
                "count": 50
            },
            {
                "code": "fairy_tale",
                "name": "童话故事",
                "count": 30
            },
            {
                "code": "fable",
                "name": "寓言故事",
                "count": 30
            }
        ]
    }
}
```

### 3.2 音频文件API

#### 3.2.1 获取音频文件

**请求:**
```http
GET /api/audio/{file_path}
```

**响应:**
- Content-Type: audio/mpeg 或 audio/wav
- 支持 Range 请求（断点续传）

**请求头示例:**
```http
GET /api/audio/stories/fairy_tale/three_pigs.mp3 HTTP/1.1
Range: bytes=0-1023
```

**响应头:**
```http
HTTP/1.1 206 Partial Content
Content-Type: audio/mpeg
Content-Range: bytes 0-1023/1048576
Content-Length: 1024
Accept-Ranges: bytes
```

### 3.3 英语学习API

#### 3.3.1 获取单词信息

**请求:**
```http
GET /api/english/word/{word}
```

**响应:**
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "word": "apple",
        "phonetic": "/ˈæp.əl/",
        "meaning": "苹果",
        "example": "I like to eat apples.",
        "example_cn": "我喜欢吃苹果。",
        "audio_url": "/api/audio/english/words/apple.mp3",
        "category": "fruits",
        "level": "basic"
    }
}
```

#### 3.3.2 获取单词列表（按分类）

**请求:**
```http
GET /api/english/words?category={category}&level={level}&page={page}&size={size}
```

**响应:**
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "total": 50,
        "items": [
            {
                "word": "apple",
                "phonetic": "/ˈæp.əl/",
                "meaning": "苹果",
                "audio_url": "/api/audio/english/words/apple.mp3"
            },
            {
                "word": "banana",
                "phonetic": "/bəˈnæn.ə/",
                "meaning": "香蕉",
                "audio_url": "/api/audio/english/words/banana.mp3"
            }
        ]
    }
}
```

### 3.4 会话管理API

#### 3.4.1 获取会话状态

**请求:**
```http
GET /api/session/{device_id}
```

**响应:**
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "session_id": "sess_12345",
        "device_id": "device_001",
        "state": "playing",
        "current_content": {
            "id": "story_001",
            "title": "三只小猪",
            "progress": 120,
            "duration": 480
        },
        "play_queue": [
            {"id": "story_002", "title": "小红帽"}
        ],
        "created_at": "2024-01-01T10:00:00Z",
        "last_active": "2024-01-01T10:05:00Z"
    }
}
```

#### 3.4.2 更新播放进度

**请求:**
```http
POST /api/session/{device_id}/progress
Content-Type: application/json

{
    "content_id": "story_001",
    "progress": 240
}
```

**响应:**
```json
{
    "code": 0,
    "message": "success"
}
```

### 3.5 系统API

#### 3.5.1 健康检查

**请求:**
```http
GET /api/health
```

**响应:**
```json
{
    "status": "healthy",
    "version": "1.0.0",
    "services": {
        "asr": "healthy",
        "tts": "healthy",
        "llm": "healthy",
        "database": "healthy"
    },
    "timestamp": "2024-01-01T10:00:00Z"
}
```

#### 3.5.2 获取系统信息

**请求:**
```http
GET /api/system/info
```

**响应:**
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "version": "1.0.0",
        "content_stats": {
            "stories": 130,
            "music": 210,
            "english_words": 500
        },
        "supported_features": [
            "story_playback",
            "music_playback",
            "english_learning",
            "chat"
        ]
    }
}
```

---

## 4. 数据模型

### 4.1 内容模型

```typescript
// 数据库存储模型 (MySQL)
interface ContentDB {
    id: number;              // 自增主键
    type: ContentType;       // 内容类型
    category: string;        // 分类
    title: string;           // 标题
    description?: string;    // 描述
    duration: number;        // 时长(秒)
    minio_path: string;      // MinIO对象路径 (如: stories/bedtime/little_red.mp3)
    cover_path?: string;     // 封面图MinIO路径
    age_min: number;         // 最小适合年龄
    age_max: number;         // 最大适合年龄
    tags?: string;           // 标签(逗号分隔)
    metadata?: object;       // 额外元数据(JSON)
    play_count: number;      // 播放次数
    created_at: string;      // 创建时间
    updated_at: string;      // 更新时间
}

// API响应模型 (包含预签名URL)
interface ContentResponse {
    id: number;              // 内容ID
    type: ContentType;       // 内容类型
    category: string;        // 分类
    title: string;           // 标题
    description?: string;    // 描述
    duration: number;        // 时长(秒)
    age_range?: [number, number];  // 适用年龄
    tags?: string[];         // 标签数组
    audio_url: string;       // MinIO预签名URL
    cover_url?: string;      // 封面预签名URL
    play_count: number;      // 播放次数
    created_at: string;      // 创建时间
}

enum ContentType {
    STORY = "story",
    MUSIC = "music",
    ENGLISH = "english"
}
```

### 4.2 会话模型

```typescript
interface Session {
    session_id: string;      // 会话ID
    device_id: string;       // 设备ID
    state: SessionState;     // 会话状态
    current_content?: {      // 当前播放内容
        id: string;
        title: string;
        progress: number;    // 播放进度(秒)
        duration: number;
    };
    play_queue: ContentRef[]; // 播放队列
    chat_history: ChatMessage[]; // 对话历史
    created_at: string;
    last_active: string;
}

enum SessionState {
    IDLE = "idle",
    LISTENING = "listening",
    PROCESSING = "processing",
    PLAYING = "playing",
    PAUSED = "paused"
}

interface ChatMessage {
    role: "user" | "assistant";
    content: string;
    timestamp: string;
}
```

### 4.3 意图模型

```typescript
interface Intent {
    name: string;            // 意图名称
    confidence: number;      // 置信度
    slots: Record<string, SlotValue>;  // 槽位
}

interface SlotValue {
    value: string;           // 槽位值
    raw_value: string;       // 原始值
    confidence: number;      // 置信度
}
```

---

## 5. 意图与槽位定义

### 5.1 意图列表

| 意图 | 说明 | 示例 |
|-----|------|-----|
| `play_story` | 播放故事（泛指） | "讲个故事" |
| `play_story_category` | 按分类播放故事 | "播放睡前故事" |
| `play_story_name` | 按名称播放故事 | "我要听三只小猪" |
| `play_music` | 播放音乐（泛指） | "放首歌" |
| `play_music_category` | 按分类播放音乐 | "播放儿歌" |
| `play_music_name` | 按名称播放音乐 | "播放小星星" |
| `control_pause` | 暂停 | "暂停" |
| `control_resume` | 继续 | "继续" |
| `control_stop` | 停止 | "停止" |
| `control_next` | 下一个 | "下一个" |
| `control_previous` | 上一个 | "上一个" |
| `control_volume` | 调节音量 | "大声点"、"音量调小" |
| `english_learn` | 学习英语 | "学英语" |
| `english_word` | 查询单词 | "苹果用英语怎么说" |
| `english_follow` | 跟读练习 | "跟我读apple" |
| `chat` | 自由对话 | "为什么天是蓝色的" |
| `system_time` | 查询时间 | "现在几点了" |
| `unknown` | 未知意图 | - |

### 5.2 槽位定义

| 槽位 | 类型 | 说明 | 示例 |
|-----|------|-----|-----|
| `story_category` | enum | 故事分类 | bedtime, fairy_tale, fable |
| `story_name` | string | 故事名称 | "三只小猪" |
| `music_category` | enum | 音乐分类 | nursery_rhyme, lullaby |
| `music_name` | string | 音乐名称 | "小星星" |
| `volume_direction` | enum | 音量方向 | up, down |
| `volume_level` | int | 音量级别 | 1-10 |
| `english_word` | string | 英语单词 | "apple" |
| `chinese_word` | string | 中文词汇 | "苹果" |

### 5.3 意图识别示例

**输入:** "我要听睡前故事"
```json
{
    "intent": "play_story_category",
    "confidence": 0.95,
    "slots": {
        "story_category": {
            "value": "bedtime",
            "raw_value": "睡前",
            "confidence": 0.92
        }
    }
}
```

**输入:** "苹果用英语怎么说"
```json
{
    "intent": "english_word",
    "confidence": 0.88,
    "slots": {
        "chinese_word": {
            "value": "苹果",
            "raw_value": "苹果",
            "confidence": 0.95
        }
    }
}
```

---

## 6. 错误处理

### 6.1 HTTP状态码

| 状态码 | 说明 |
|-------|-----|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 404 | 资源不存在 |
| 429 | 请求频率过高 |
| 500 | 服务器内部错误 |

### 6.2 业务错误码

| 错误码 | 说明 |
|-------|-----|
| 0 | 成功 |
| 1001 | 参数缺失 |
| 1002 | 参数格式错误 |
| 2001 | 内容不存在 |
| 2002 | 分类不存在 |
| 3001 | ASR识别失败 |
| 3002 | TTS合成失败 |
| 3003 | LLM服务异常 |
| 4001 | 会话不存在 |
| 4002 | 会话已过期 |
| 5001 | 系统内部错误 |

### 6.3 错误响应格式

```json
{
    "code": 2001,
    "message": "内容不存在",
    "detail": "未找到ID为story_999的内容",
    "timestamp": "2024-01-01T10:00:00Z"
}
```

---

## 7. 安全与认证

### 7.1 设备认证（MVP简化版）

MVP阶段使用简单的设备ID认证：

```http
GET /api/content HTTP/1.1
X-Device-ID: device_001
```

### 7.2 未来扩展：Token认证

```http
GET /api/content HTTP/1.1
Authorization: Bearer <jwt_token>
```

### 7.3 请求限流

| 接口类型 | 限制 |
|---------|-----|
| WebSocket连接 | 每设备1个 |
| 语音请求 | 10次/分钟 |
| 内容查询 | 60次/分钟 |

---

## 8. SDK使用示例

### 8.1 Python客户端示例

```python
import asyncio
import websockets
import json
import base64

class VoiceGrowClient:
    def __init__(self, server_url: str, device_id: str):
        self.server_url = server_url
        self.device_id = device_id
        self.ws = None

    async def connect(self):
        url = f"{self.server_url}/ws/voice?device_id={self.device_id}"
        self.ws = await websockets.connect(url)

    async def send_audio(self, audio_data: bytes):
        message = {
            "type": "audio",
            "data": base64.b64encode(audio_data).decode(),
            "format": "wav",
            "sample_rate": 16000,
            "timestamp": int(time.time() * 1000)
        }
        await self.ws.send(json.dumps(message))

    async def receive_response(self):
        response = await self.ws.recv()
        return json.loads(response)

    async def send_command(self, action: str):
        message = {
            "type": "command",
            "action": action,
            "timestamp": int(time.time() * 1000)
        }
        await self.ws.send(json.dumps(message))

# 使用示例
async def main():
    client = VoiceGrowClient("ws://localhost:8000", "device_001")
    await client.connect()

    # 发送音频
    with open("audio.wav", "rb") as f:
        audio_data = f.read()
    await client.send_audio(audio_data)

    # 接收响应
    response = await client.receive_response()
    print(response)

asyncio.run(main())
```

### 8.2 HTTP API调用示例

```python
import requests

class VoiceGrowAPI:
    def __init__(self, base_url: str, device_id: str):
        self.base_url = base_url
        self.headers = {"X-Device-ID": device_id}

    def get_content_list(self, content_type: str = None, category: str = None):
        params = {}
        if content_type:
            params["type"] = content_type
        if category:
            params["category"] = category

        response = requests.get(
            f"{self.base_url}/api/content",
            params=params,
            headers=self.headers
        )
        return response.json()

    def get_random_content(self, content_type: str, category: str = None):
        params = {"type": content_type}
        if category:
            params["category"] = category

        response = requests.get(
            f"{self.base_url}/api/content/random",
            params=params,
            headers=self.headers
        )
        return response.json()

# 使用示例
api = VoiceGrowAPI("http://localhost:8000", "device_001")

# 获取故事列表
stories = api.get_content_list(content_type="story", category="bedtime")
print(stories)

# 获取随机儿歌
music = api.get_random_content(content_type="music", category="nursery_rhyme")
print(music)
```

---

## 附录A: 内容分类代码表

### 故事分类
| 代码 | 名称 |
|-----|-----|
| bedtime | 睡前故事 |
| fairy_tale | 童话故事 |
| fable | 寓言故事 |
| science | 科普故事 |
| chinese_classic | 国学经典 |

### 音乐分类
| 代码 | 名称 |
|-----|-----|
| nursery_rhyme | 儿歌 |
| lullaby | 摇篮曲 |
| prenatal | 胎教音乐 |
| classical | 古典音乐 |
| english_song | 英文儿歌 |

### 英语分类
| 代码 | 名称 |
|-----|-----|
| basic | 基础词汇 |
| animals | 动物 |
| colors | 颜色 |
| numbers | 数字 |
| fruits | 水果 |
| body | 身体部位 |
| family | 家庭成员 |
