# VoiceGrow 系统架构文档

> 版本: v1.0
> 更新日期: 2026-01-12

---

## 1. 架构概述

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                用户交互层                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                        小爱音箱 (Client)                               │  │
│  │   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐              │  │
│  │   │麦克风   │   │扬声器   │   │唤醒词   │   │网络模块 │              │  │
│  │   │阵列     │   │         │   │检测     │   │         │              │  │
│  │   └────┬────┘   └────▲────┘   └────┬────┘   └────┬────┘              │  │
│  │        │             │             │             │                    │  │
│  │        └─────────────┴─────────────┴─────────────┘                    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ WebSocket / HTTP
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                服务接入层                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           API Gateway                                  │  │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │  │
│  │   │ WebSocket   │   │ REST API    │   │ 认证/限流   │                │  │
│  │   │ Handler     │   │ Handler     │   │             │                │  │
│  │   └──────┬──────┘   └──────┬──────┘   └─────────────┘                │  │
│  └──────────┼─────────────────┼─────────────────────────────────────────┘  │
└─────────────┼─────────────────┼─────────────────────────────────────────────┘
              │                 │
              ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                核心服务层                                    │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │   ASR      │  │   NLU      │  │   TTS      │  │   LLM      │            │
│  │  Service   │  │  Service   │  │  Service   │  │  Service   │            │
│  │ (Whisper)  │  │ (Router)   │  │  (Azure)   │  │ (OpenAI)   │            │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘            │
│        │               │               │               │                    │
│        └───────────────┴───────────────┴───────────────┘                    │
│                                │                                            │
│  ┌─────────────────────────────▼─────────────────────────────────────────┐  │
│  │                        Session Manager                                 │  │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │  │
│  │   │ 会话状态    │   │ 上下文管理  │   │ 播放状态    │                │  │
│  │   └─────────────┘   └─────────────┘   └─────────────┘                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                业务服务层                                    │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │   Story    │  │   Music    │  │  English   │  │   Chat     │            │
│  │  Service   │  │  Service   │  │  Service   │  │  Service   │            │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘            │
│        │               │               │               │                    │
│        └───────────────┴───────────────┴───────────────┘                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                数据存储层                                    │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │     MySQL        │  │     MinIO        │  │   Redis (可选)   │          │
│  │   (Metadata)     │  │  (Audio Files)   │  │   (Session)      │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 组件说明

| 层级 | 组件 | 职责 |
|-----|------|-----|
| 用户交互层 | 小爱音箱客户端 (open-xiaoai) | 音频流转发、设备事件传输、命令执行 |
| 服务接入层 | API Gateway | 请求路由、协议转换、认证限流 |
| 核心服务层 | ASR/NLU/TTS/LLM | 语音识别、意图理解、语音合成、对话生成 |
| 业务服务层 | Story/Music/English/Chat | 具体业务逻辑实现 |
| 数据存储层 | MySQL/MinIO | 元数据存储 (MySQL)、音频文件存储 (MinIO) |

---

## 2. 模块详细设计

### 2.1 客户端说明（open-xiaoai）

客户端使用 **open-xiaoai** 开源项目，无需自行开发。

> ⚠️ **支持的设备型号**：仅支持 **LX06 (小爱音箱 Pro)** 和 **OH2P (Xiaomi Smart Speaker Pro)**

```
┌─────────────────────────────────────────────────────────────┐
│              open-xiaoai Rust 客户端                         │
│              (已实现，无需开发)                               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   核心功能                            │   │
│  │  ┌───────────────┐  ┌───────────────┐              │   │
│  │  │ 麦克风音频流  │  │ 设备事件传输  │              │   │
│  │  │ 转发         │  │ (ASR结果等)   │              │   │
│  │  └───────────────┘  └───────────────┘              │   │
│  │  ┌───────────────┐  ┌───────────────┐              │   │
│  │  │ 服务端命令   │  │ WebSocket通信  │              │   │
│  │  │ 执行         │  │ (端口4399)    │              │   │
│  │  └───────────────┘  └───────────────┘              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  项目地址: https://github.com/idootop/open-xiaoai          │
└─────────────────────────────────────────────────────────────┘
```

#### 2.1.1 交互流程

```
open-xiaoai Client                    VoiceGrow Server
       │                                     │
       │  1. WebSocket连接 (端口4399)        │
       │──────────────────────────────────→  │
       │                                     │
       │  2. 音频流转发                       │
       │──────────────────────────────────→  │
       │                                     │ (ASR识别)
       │                                     │ (NLU意图理解)
       │                                     │ (业务处理)
       │                                     │
       │  3. 播放指令/TTS                    │
       │  ←──────────────────────────────────│
       │                                     │
       │  (客户端执行播放)                    │
       │                                     │
```

### 2.2 服务端架构

```
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI Application                       │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Routers                           │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐       │   │
│  │  │/ws/voice  │  │/api/audio │  │/api/content│       │   │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘       │   │
│  └────────┼──────────────┼──────────────┼───────────────┘   │
│           │              │              │                    │
│  ┌────────▼──────────────▼──────────────▼───────────────┐   │
│  │                  Core Services                        │   │
│  │                                                       │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │              Voice Pipeline                  │    │   │
│  │  │  Audio → ASR → NLU → Router → Response      │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │   │
│  │  │   ASR    │ │   NLU    │ │   TTS    │ │  LLM   │ │   │
│  │  │ Service  │ │ Service  │ │ Service  │ │Service │ │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └────────┘ │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                Business Services                       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │   │
│  │  │  Story   │ │  Music   │ │ English  │ │   Chat   │ │   │
│  │  │ Handler  │ │ Handler  │ │ Handler  │ │ Handler  │ │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                   Data Layer                          │   │
│  │  ┌──────────────┐  ┌──────────────┐                  │   │
│  │  │ ContentRepo  │  │ SessionRepo  │                  │   │
│  │  └──────────────┘  └──────────────┘                  │   │
│  └───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 数据流设计

### 3.1 语音交互主流程

```
┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐
│ Client │      │  ASR   │      │  NLU   │      │Handler │
└───┬────┘      └───┬────┘      └───┬────┘      └───┬────┘
    │               │               │               │
    │  1. 音频数据  │               │               │
    │──────────────>│               │               │
    │               │               │               │
    │               │ 2. 转录文本   │               │
    │               │──────────────>│               │
    │               │               │               │
    │               │               │ 3. 意图+槽位  │
    │               │               │──────────────>│
    │               │               │               │
    │               │               │               │ 4. 处理业务
    │               │               │               │────┐
    │               │               │               │    │
    │               │               │               │<───┘
    │               │               │               │
    │ 5. 响应结果（文本+音频URL/TTS）               │
    │<─────────────────────────────────────────────│
    │               │               │               │
```

### 3.2 故事播放流程

```
用户: "讲个睡前故事"
         │
         ▼
┌─────────────────┐
│ ASR: 语音识别   │
│ Text: "讲个睡前故事"
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ NLU: 意图识别   │
│ Intent: PLAY_STORY_CATEGORY
│ Slots: {category: "bedtime"}
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Router: 路由    │
│ → StoryHandler  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ StoryHandler:   │
│ 1. MySQL查询bedtime类故事
│ 2. 随机选择一个
│ 3. 获取minio_path
│ 4. 生成MinIO预签名URL
│ 5. 生成回复文本
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ TTS: 合成回复   │
│ "好的，为你播放《小红帽》"
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Response:                           │
│ {                                   │
│   text: "好的，为你播放《小红帽》",   │
│   audio_url: "http://minio:9000/    │
│     voicegrow-bucket/stories/       │
│     bedtime/little_red.mp3?         │
│     X-Amz-Signature=..."            │
│ }                                   │
└─────────────────────────────────────┘
```

### 3.3 智能对话流程

```
用户: "为什么天空是蓝色的"
         │
         ▼
┌─────────────────┐
│ ASR: 语音识别   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ NLU: 意图识别   │
│ Intent: CHAT    │ (无法匹配预设意图)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ ChatHandler:    │
│ 1. 构建prompt   │
│ 2. 调用LLM API  │
│ 3. 内容安全过滤 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ LLM Response:   │
│ "天空是蓝色的因为...
│  (儿童友好的简短解释)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ TTS: 合成回复   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 流式返回音频    │
└─────────────────┘
```

---

## 4. 意图路由设计

### 4.1 路由架构

```
                    ┌───────────────────┐
                    │    NLU Output     │
                    │ Intent + Slots    │
                    └─────────┬─────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │   Intent Router   │
                    └─────────┬─────────┘
                              │
         ┌────────────────────┼────────────────────┐
         │                    │                    │
         ▼                    ▼                    ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  Content Group  │ │  Control Group  │ │   Chat Group    │
│                 │ │                 │ │                 │
│ • PLAY_STORY    │ │ • CONTROL_PAUSE │ │ • CHAT          │
│ • PLAY_MUSIC    │ │ • CONTROL_RESUME│ │ • SYSTEM_TIME   │
│ • ENGLISH_LEARN │ │ • CONTROL_VOLUME│ │ • SYSTEM_WEATHER│
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                    │
         ▼                   ▼                    ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ StoryHandler    │ │ ControlHandler  │ │ ChatHandler     │
│ MusicHandler    │ │                 │ │                 │
│ EnglishHandler  │ │                 │ │                 │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

### 4.2 Handler接口定义

```python
from abc import ABC, abstractmethod
from dataclasses import dataclass

@dataclass
class HandlerRequest:
    intent: str
    slots: dict
    text: str
    session_id: str
    context: dict

@dataclass
class HandlerResponse:
    text: str                    # 回复文本
    audio_url: str | None        # 内容音频URL
    tts_required: bool           # 是否需要TTS合成text
    action: str | None           # 控制动作
    context_update: dict | None  # 上下文更新

class BaseHandler(ABC):
    @abstractmethod
    async def handle(self, request: HandlerRequest) -> HandlerResponse:
        pass

    @abstractmethod
    def can_handle(self, intent: str) -> bool:
        pass
```

---

## 5. 会话管理设计

### 5.1 会话状态

```python
from enum import Enum
from dataclasses import dataclass, field
from datetime import datetime

class SessionState(Enum):
    IDLE = "idle"
    LISTENING = "listening"
    PROCESSING = "processing"
    PLAYING = "playing"
    PAUSED = "paused"

@dataclass
class Session:
    session_id: str
    device_id: str
    state: SessionState = SessionState.IDLE
    current_content: dict | None = None
    play_queue: list = field(default_factory=list)
    chat_history: list = field(default_factory=list)
    created_at: datetime = field(default_factory=datetime.now)
    last_active: datetime = field(default_factory=datetime.now)

    def add_chat_message(self, role: str, content: str):
        self.chat_history.append({
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat()
        })
        # 保持最近10轮对话
        if len(self.chat_history) > 20:
            self.chat_history = self.chat_history[-20:]
```

### 5.2 会话管理器

```python
class SessionManager:
    def __init__(self):
        self.sessions: dict[str, Session] = {}
        self.session_timeout = 300  # 5分钟超时

    async def get_or_create(self, device_id: str) -> Session:
        if device_id in self.sessions:
            session = self.sessions[device_id]
            session.last_active = datetime.now()
            return session

        session = Session(
            session_id=str(uuid.uuid4()),
            device_id=device_id
        )
        self.sessions[device_id] = session
        return session

    async def update_state(self, device_id: str, state: SessionState):
        if device_id in self.sessions:
            self.sessions[device_id].state = state
            self.sessions[device_id].last_active = datetime.now()

    async def cleanup_expired(self):
        """清理过期会话"""
        now = datetime.now()
        expired = [
            did for did, session in self.sessions.items()
            if (now - session.last_active).seconds > self.session_timeout
        ]
        for did in expired:
            del self.sessions[did]
```

---

## 6. 内容管理架构

### 6.1 存储架构

VoiceGrow 采用 **MinIO + MySQL** 架构进行内容管理：

```
┌─────────────────────────────────────────────────────────────┐
│                    内容管理存储架构                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    检索元数据    ┌─────────────────────┐  │
│  │             │ ───────────────> │                     │  │
│  │  VoiceGrow  │                  │      MySQL          │  │
│  │   Server    │ <─────────────── │   (内容元数据)       │  │
│  │             │   返回MinIO路径   │   - type/category   │  │
│  └──────┬──────┘                  │   - title/duration  │  │
│         │                         │   - minio_path      │  │
│         │                         └─────────────────────┘  │
│         │ 生成预签名URL                                     │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                     MinIO                            │   │
│  │              (对象存储 - 音频文件)                    │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │            voicegrow-bucket                 │    │   │
│  │  │  ├── stories/    (故事音频)                 │    │   │
│  │  │  ├── music/      (音乐文件)                 │    │   │
│  │  │  ├── english/    (英语学习音频)             │    │   │
│  │  │  └── covers/     (封面图片)                 │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 内容分类体系

```
Content
├── Stories (故事)
│   ├── bedtime (睡前故事)
│   ├── fairy_tale (童话故事)
│   ├── fable (寓言故事)
│   ├── science (科普故事)
│   └── chinese_classic (国学经典)
│
├── Music (音乐)
│   ├── nursery_rhyme (儿歌)
│   ├── lullaby (摇篮曲)
│   ├── prenatal (胎教音乐)
│   ├── classical (古典音乐)
│   └── english_song (英文儿歌)
│
└── English (英语学习)
    ├── words (单词)
    │   ├── basic (基础词汇)
    │   ├── animals (动物)
    │   ├── colors (颜色)
    │   └── numbers (数字)
    ├── phrases (短语)
    └── dialogues (对话场景)
```

### 6.3 内容检索流程

```
                    ┌───────────────────┐
                    │   Search Request  │
                    │ type, category,   │
                    │ keyword, random   │
                    └─────────┬─────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │  Content Service  │
                    └─────────┬─────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
     ┌────────────┐  ┌────────────┐  ┌────────────┐
     │ By Keyword │  │ By Category│  │  Random    │
     │   Search   │  │   Filter   │  │  Select    │
     └─────┬──────┘  └─────┬──────┘  └─────┬──────┘
           │               │               │
           └───────────────┼───────────────┘
                           │
                           ▼
                    ┌───────────────────┐
                    │   MySQL Query     │
                    │  (元数据检索)      │
                    └─────────┬─────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │  获取 minio_path  │
                    └─────────┬─────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │   MinIO Service   │
                    │  生成预签名URL     │
                    └─────────┬─────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │   Content List    │
                    │  (包含audio_url)  │
                    └───────────────────┘
```

---

## 7. 扩展性设计

### 7.1 插件化Handler

```python
# 注册新的Handler
class HandlerRegistry:
    _handlers: list[BaseHandler] = []

    @classmethod
    def register(cls, handler: BaseHandler):
        cls._handlers.append(handler)

    @classmethod
    def get_handler(cls, intent: str) -> BaseHandler | None:
        for handler in cls._handlers:
            if handler.can_handle(intent):
                return handler
        return None

# 使用装饰器注册
def register_handler(cls):
    HandlerRegistry.register(cls())
    return cls

@register_handler
class JapaneseHandler(BaseHandler):
    """日语学习Handler - Phase 2扩展"""

    def can_handle(self, intent: str) -> bool:
        return intent.startswith("JAPANESE_")

    async def handle(self, request: HandlerRequest) -> HandlerResponse:
        # 实现日语学习逻辑
        pass
```

### 7.2 内容提供者扩展

```python
from abc import ABC, abstractmethod

class ContentProvider(ABC):
    @abstractmethod
    async def search(self, query: dict) -> list[Content]:
        pass

    @abstractmethod
    async def get_stream_url(self, content_id: str) -> str:
        pass

class LocalContentProvider(ContentProvider):
    """本地内容提供者 - MVP"""
    pass

class OnlineContentProvider(ContentProvider):
    """在线内容提供者 - 未来扩展"""
    pass

class AIGeneratedContentProvider(ContentProvider):
    """AI生成内容提供者 - 未来扩展"""
    pass
```

---

## 8. 错误处理与容错

### 8.1 错误分类

| 错误类型 | 示例 | 处理策略 |
|---------|-----|---------|
| 网络错误 | WebSocket断开 | 自动重连，本地缓存播放 |
| ASR错误 | 识别失败 | 友好提示，请求重说 |
| 内容错误 | 内容未找到 | 推荐相似内容 |
| LLM错误 | API超时 | 返回预设回复 |
| 系统错误 | 服务崩溃 | 自动重启，错误日志 |

### 8.2 降级策略

```python
class DegradationStrategy:
    """服务降级策略"""

    @staticmethod
    async def asr_fallback(audio: bytes) -> str:
        """ASR降级：使用备用模型"""
        try:
            return await primary_asr.transcribe(audio)
        except Exception:
            return await backup_asr.transcribe(audio)

    @staticmethod
    async def llm_fallback(message: str) -> str:
        """LLM降级：使用预设回复"""
        try:
            return await llm_service.chat(message)
        except Exception:
            return "抱歉，我现在有点忙，稍后再试试吧"

    @staticmethod
    async def tts_fallback(text: str) -> bytes:
        """TTS降级：使用本地TTS"""
        try:
            return await azure_tts.synthesize(text)
        except Exception:
            return await local_tts.synthesize(text)
```

---

## 9. 监控与日志

### 9.1 关键指标

```python
METRICS = {
    # 性能指标
    "asr_latency": Histogram("ASR处理延迟"),
    "tts_latency": Histogram("TTS处理延迟"),
    "llm_latency": Histogram("LLM响应延迟"),
    "e2e_latency": Histogram("端到端延迟"),

    # 业务指标
    "request_total": Counter("请求总数"),
    "intent_distribution": Counter("意图分布"),
    "content_plays": Counter("内容播放次数"),

    # 错误指标
    "asr_errors": Counter("ASR错误数"),
    "llm_errors": Counter("LLM错误数"),
    "system_errors": Counter("系统错误数"),
}
```

### 9.2 日志规范

```python
import structlog

logger = structlog.get_logger()

# 请求日志
logger.info("voice_request",
    session_id=session.session_id,
    device_id=device_id,
    audio_duration=audio_duration
)

# ASR日志
logger.info("asr_complete",
    session_id=session.session_id,
    text=transcribed_text,
    latency_ms=latency
)

# 错误日志
logger.error("llm_error",
    session_id=session.session_id,
    error=str(e),
    message=user_message
)
```

---

## 10. 安全架构

### 10.1 安全边界

```
┌─────────────────────────────────────────────────────────────┐
│                    安全边界                                  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                内容安全层                            │   │
│  │  • LLM输出过滤                                      │   │
│  │  • 敏感词检测                                       │   │
│  │  • 儿童内容审核                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                隐私保护层                            │   │
│  │  • 语音本地处理 (ASR)                               │   │
│  │  • 最小化数据收集                                   │   │
│  │  • 会话数据定期清理                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                访问控制层                            │   │
│  │  • 设备认证                                         │   │
│  │  • 家长控制 (未来)                                  │   │
│  │  • 使用时长限制 (未来)                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 内容过滤实现

```python
class ContentSafetyFilter:
    def __init__(self):
        self.blocked_patterns = self._load_patterns()

    async def filter_llm_output(self, text: str) -> tuple[bool, str]:
        """
        过滤LLM输出
        Returns: (is_safe, filtered_text)
        """
        # 1. 关键词过滤
        for pattern in self.blocked_patterns:
            if re.search(pattern, text):
                return False, self._get_safe_response()

        # 2. 长度检查（避免过长回复）
        if len(text) > 500:
            text = text[:500] + "..."

        return True, text

    def _get_safe_response(self) -> str:
        responses = [
            "这个问题有点难，我们换一个话题吧",
            "我不太确定这个答案，要不我们聊点别的",
            "嗯...让我想想，我们先听个故事吧"
        ]
        return random.choice(responses)
```
