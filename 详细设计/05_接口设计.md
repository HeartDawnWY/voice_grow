# VoiceGrow 接口设计文档

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| 1.0 | 2025-01 | VoiceGrow Team | 初始版本 |

---

## 目录

1. [接口概述](#1-接口概述)
2. [WebSocket 接口](#2-websocket-接口)
3. [HTTP REST 接口](#3-http-rest-接口)
4. [外部服务接口](#4-外部服务接口)
5. [错误码定义](#5-错误码定义)
6. [接口安全](#6-接口安全)
7. [接口版本管理](#7-接口版本管理)

---

## 1. 接口概述

### 1.1 接口分类

```
┌─────────────────────────────────────────────────────────────────┐
│                      VoiceGrow 接口体系                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  WebSocket API  │  │  HTTP REST API  │  │  外部服务 API   │ │
│  │                 │  │                 │  │                 │ │
│  │  • 设备通信     │  │  • 内容管理     │  │  • ai-manager   │ │
│  │  • 实时音频     │  │  • 系统管理     │  │    (TTS/LLM)    │ │
│  │  • 事件推送     │  │  • 健康检查     │  │  • MinIO        │ │
│  │                 │  │                 │  │  • MySQL        │ │
│  │  Port: 4399     │  │  Port: 8000     │  │  • Redis        │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 接口规范

| 规范项 | 说明 |
|--------|------|
| 协议版本 | WebSocket RFC 6455, HTTP/1.1 |
| 数据格式 | JSON (UTF-8编码) |
| 时间格式 | ISO 8601 (YYYY-MM-DDTHH:mm:ss.sssZ) |
| 字符编码 | UTF-8 |
| 压缩 | 支持 gzip (HTTP), 不压缩 (WebSocket) |

### 1.3 通用响应格式

```json
{
    "code": 0,
    "message": "success",
    "data": { ... },
    "timestamp": "2025-01-20T10:30:00.000Z",
    "request_id": "req_abc123"
}
```

---

## 2. WebSocket 接口

### 2.1 连接规范

#### 2.1.1 连接地址

```
ws://<server_host>:4399/ws
```

#### 2.1.2 连接参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| device_id | string | 是 | 设备唯一标识 |
| device_model | string | 否 | 设备型号 (LX06/OH2P) |
| client_version | string | 否 | 客户端版本号 |

#### 2.1.3 连接示例

```
ws://192.168.1.100:4399/ws?device_id=abc123&device_model=LX06
```

#### 2.1.4 连接生命周期

```
┌──────────┐                              ┌──────────┐
│  Client  │                              │  Server  │
└────┬─────┘                              └────┬─────┘
     │                                         │
     │  1. WebSocket Handshake                 │
     │ ──────────────────────────────────────> │
     │                                         │
     │  2. Connection Accepted                 │
     │ <────────────────────────────────────── │
     │                                         │
     │  3. Send device_info Event              │
     │ ──────────────────────────────────────> │
     │                                         │
     │  4. Connection Confirmed                │
     │ <────────────────────────────────────── │
     │                                         │
     │  5. Normal Communication                │
     │ <─────────────────────────────────────> │
     │                                         │
     │  6. Heartbeat (every 30s)               │
     │ <─────────────────────────────────────> │
     │                                         │
     │  7. Close Connection                    │
     │ ──────────────────────────────────────> │
     │                                         │
```

### 2.2 消息格式

#### 2.2.1 消息类型

| 类型 | 方向 | 说明 |
|------|------|------|
| Event | Client → Server | 客户端事件上报 |
| Request | Server → Client | 服务端请求命令 |
| Response | Client → Server | 客户端命令响应 |
| Binary | Client → Server | 二进制音频数据 |

#### 2.2.2 Event 消息 (Client → Server)

**通用格式:**

```json
{
    "type": "Event",
    "event": "<event_name>",
    "data": { ... },
    "timestamp": 1705737000000
}
```

**事件类型:**

| 事件名 | 说明 | 触发时机 |
|--------|------|----------|
| kws | 唤醒词检测 | 检测到"小爱同学" |
| playing | 播放状态 | 播放开始/结束/暂停 |
| instruction | ASR 指令 | 语音识别完成 |
| record | 音频流状态 | 录音开始/结束 |
| device_info | 设备信息 | 连接建立后 |
| heartbeat | 心跳 | 定期发送 |

**kws 事件示例:**

```json
{
    "type": "Event",
    "event": "kws",
    "data": {
        "keyword": "小爱同学",
        "confidence": 0.95
    },
    "timestamp": 1705737000000
}
```

**playing 事件示例:**

```json
{
    "type": "Event",
    "event": "playing",
    "data": {
        "status": "playing",
        "url": "http://minio:9000/voicegrow/stories/story_001.mp3",
        "position": 30,
        "duration": 180
    },
    "timestamp": 1705737000000
}
```

**instruction 事件示例:**

```json
{
    "type": "Event",
    "event": "instruction",
    "data": {
        "text": "讲个睡前故事",
        "asr_source": "server"
    },
    "timestamp": 1705737000000
}
```

**record 事件示例:**

```json
{
    "type": "Event",
    "event": "record",
    "data": {
        "action": "start",
        "format": "pcm",
        "sample_rate": 16000,
        "channels": 1,
        "bits_per_sample": 16
    },
    "timestamp": 1705737000000
}
```

#### 2.2.3 Request 消息 (Server → Client)

**通用格式:**

```json
{
    "type": "Request",
    "command": "<command_name>",
    "data": { ... },
    "request_id": "req_abc123"
}
```

**命令类型:**

| 命令名 | 说明 | 参数 |
|--------|------|------|
| play_url | 播放音频URL | url, volume |
| play_text | TTS播放文本 | text, voice |
| play | 继续播放 | - |
| pause | 暂停播放 | - |
| stop | 停止播放 | - |
| mic_on | 开启麦克风 | - |
| mic_off | 关闭麦克风 | - |
| wake_up | 模拟唤醒 | - |
| abort_xiaoai | 中断小爱 | - |
| set_volume | 设置音量 | volume (0-100) |
| get_status | 获取状态 | - |

**play_url 命令示例:**

```json
{
    "type": "Request",
    "command": "play_url",
    "data": {
        "url": "http://minio:9000/voicegrow/stories/story_001.mp3",
        "volume": 50
    },
    "request_id": "req_play_001"
}
```

**play_text 命令示例:**

```json
{
    "type": "Request",
    "command": "play_text",
    "data": {
        "text": "好的，我来给你讲一个睡前故事",
        "voice": "zh-CN-XiaoxiaoNeural"
    },
    "request_id": "req_tts_001"
}
```

#### 2.2.4 Response 消息 (Client → Server)

**通用格式:**

```json
{
    "type": "Response",
    "request_id": "req_abc123",
    "success": true,
    "data": { ... },
    "error": null
}
```

**成功响应示例:**

```json
{
    "type": "Response",
    "request_id": "req_play_001",
    "success": true,
    "data": {
        "status": "playing"
    },
    "error": null
}
```

**失败响应示例:**

```json
{
    "type": "Response",
    "request_id": "req_play_001",
    "success": false,
    "data": null,
    "error": {
        "code": 1001,
        "message": "Audio playback failed: network error"
    }
}
```

#### 2.2.5 Binary 消息 (音频数据)

**格式规范:**

| 参数 | 值 |
|------|-----|
| 采样率 | 16000 Hz |
| 位深度 | 16 bit |
| 声道数 | 1 (单声道) |
| 编码格式 | PCM (小端序) |
| 帧大小 | 3200 bytes (100ms) |

**二进制帧结构:**

```
┌────────────────────────────────────────────┐
│  Header (4 bytes)  │  Audio Data (N bytes) │
├────────────────────┼───────────────────────┤
│  Frame Length (u32)│  PCM Audio Samples    │
└────────────────────┴───────────────────────┘
```

### 2.3 交互流程

#### 2.3.1 语音交互完整流程

```
┌──────────┐                              ┌──────────┐
│  Client  │                              │  Server  │
└────┬─────┘                              └────┬─────┘
     │                                         │
     │  1. Event: kws (唤醒词检测)              │
     │ ──────────────────────────────────────> │
     │                                         │
     │  2. Request: mic_on (开启录音)           │
     │ <────────────────────────────────────── │
     │                                         │
     │  3. Response: mic_on success            │
     │ ──────────────────────────────────────> │
     │                                         │
     │  4. Event: record start                 │
     │ ──────────────────────────────────────> │
     │                                         │
     │  5. Binary: audio data (多帧)           │
     │ ──────────────────────────────────────> │
     │ ──────────────────────────────────────> │
     │ ──────────────────────────────────────> │
     │                                         │
     │  6. Event: record stop                  │
     │ ──────────────────────────────────────> │
     │                                         │
     │  7. Request: mic_off (关闭录音)          │
     │ <────────────────────────────────────── │
     │                                         │
     │            [Server ASR Processing]      │
     │                                         │
     │  8. Event: instruction (ASR结果)        │
     │ ──────────────────────────────────────> │
     │                                         │
     │            [Server NLU + Handler]       │
     │                                         │
     │  9. Request: play_url (播放音频)         │
     │ <────────────────────────────────────── │
     │                                         │
     │  10. Response: play_url success         │
     │ ──────────────────────────────────────> │
     │                                         │
     │  11. Event: playing (播放状态)          │
     │ ──────────────────────────────────────> │
     │                                         │
```

#### 2.3.2 播放控制流程

```
┌──────────┐                              ┌──────────┐
│  Client  │                              │  Server  │
└────┬─────┘                              └────┬─────┘
     │                                         │
     │  User says: "暂停"                       │
     │                                         │
     │  1. Event: instruction                  │
     │     { "text": "暂停" }                   │
     │ ──────────────────────────────────────> │
     │                                         │
     │            [NLU: control_pause]         │
     │                                         │
     │  2. Request: pause                      │
     │ <────────────────────────────────────── │
     │                                         │
     │  3. Response: pause success             │
     │ ──────────────────────────────────────> │
     │                                         │
     │  4. Event: playing                      │
     │     { "status": "paused" }              │
     │ ──────────────────────────────────────> │
     │                                         │
```

### 2.4 心跳机制

#### 2.4.1 心跳配置

| 参数 | 值 | 说明 |
|------|-----|------|
| 心跳间隔 | 30秒 | 客户端发送间隔 |
| 超时时间 | 90秒 | 服务端判断断连 |
| 重试次数 | 3次 | 连续超时后断开 |

#### 2.4.2 心跳消息

**Client → Server:**

```json
{
    "type": "Event",
    "event": "heartbeat",
    "data": {
        "client_time": 1705737000000
    },
    "timestamp": 1705737000000
}
```

**Server → Client:**

```json
{
    "type": "Request",
    "command": "heartbeat_ack",
    "data": {
        "server_time": 1705737000100
    },
    "request_id": "hb_001"
}
```

---

## 3. HTTP REST 接口

### 3.1 接口基础

#### 3.1.1 基础URL

```
http://<server_host>:8000/api/v1
```

#### 3.1.2 请求头

| Header | 值 | 说明 |
|--------|-----|------|
| Content-Type | application/json | 请求体格式 |
| Accept | application/json | 响应格式 |
| X-Request-ID | uuid | 请求追踪ID |

### 3.2 健康检查接口

#### 3.2.1 基础健康检查

**请求:**

```http
GET /api/v1/health
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "status": "healthy",
        "version": "1.0.0",
        "uptime": 3600
    }
}
```

#### 3.2.2 详细健康检查

**请求:**

```http
GET /api/v1/health/detail
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "status": "healthy",
        "components": {
            "mysql": {
                "status": "healthy",
                "latency_ms": 5
            },
            "redis": {
                "status": "healthy",
                "latency_ms": 2
            },
            "minio": {
                "status": "healthy",
                "latency_ms": 10
            },
            "asr": {
                "status": "healthy",
                "model": "whisper-small"
            },
            "tts": {
                "status": "healthy",
                "provider": "azure"
            }
        }
    }
}
```

### 3.3 内容管理接口

#### 3.3.1 获取内容列表

**请求:**

```http
GET /api/v1/contents?type=story&category=bedtime&page=1&size=20
```

**参数:**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | string | 否 | 内容类型: story/music/english/sound |
| category | string | 否 | 分类名称 |
| page | int | 否 | 页码 (默认1) |
| size | int | 否 | 每页数量 (默认20, 最大100) |
| keyword | string | 否 | 搜索关键词 |

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "items": [
            {
                "id": 1,
                "type": "story",
                "category": "bedtime",
                "title": "晚安小熊",
                "description": "温馨的睡前故事",
                "cover_url": "http://minio:9000/voicegrow/covers/bear.jpg",
                "duration": 180,
                "play_count": 1000
            }
        ],
        "total": 50,
        "page": 1,
        "size": 20,
        "pages": 3
    }
}
```

#### 3.3.2 获取内容详情

**请求:**

```http
GET /api/v1/contents/{content_id}
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "id": 1,
        "type": "story",
        "category": "bedtime",
        "title": "晚安小熊",
        "description": "温馨的睡前故事",
        "audio_url": "http://minio:9000/voicegrow/stories/bear.mp3?X-Amz-...",
        "cover_url": "http://minio:9000/voicegrow/covers/bear.jpg",
        "duration": 180,
        "format": "mp3",
        "file_size": 2880000,
        "tags": ["睡前", "温馨", "小熊"],
        "age_min": 3,
        "age_max": 6,
        "play_count": 1000,
        "like_count": 500,
        "created_at": "2025-01-01T00:00:00Z"
    }
}
```

#### 3.3.3 获取分类列表

**请求:**

```http
GET /api/v1/contents/categories?type=story
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "categories": [
            {
                "name": "bedtime",
                "display_name": "睡前故事",
                "count": 50,
                "icon": "moon"
            },
            {
                "name": "fairy_tale",
                "display_name": "童话故事",
                "count": 100,
                "icon": "castle"
            }
        ]
    }
}
```

#### 3.3.4 随机获取内容

**请求:**

```http
GET /api/v1/contents/random?type=story&category=bedtime
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "id": 15,
        "type": "story",
        "category": "bedtime",
        "title": "月亮船",
        "audio_url": "http://minio:9000/voicegrow/stories/moon_boat.mp3?X-Amz-..."
    }
}
```

### 3.4 英语学习接口

#### 3.4.1 获取单词列表

**请求:**

```http
GET /api/v1/english/words?level=basic&category=animal&page=1&size=20
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "items": [
            {
                "id": 1,
                "word": "dog",
                "phonetic": "/dɒɡ/",
                "translation": "狗",
                "level": "basic",
                "category": "animal"
            }
        ],
        "total": 100,
        "page": 1,
        "size": 20
    }
}
```

#### 3.4.2 获取单词详情

**请求:**

```http
GET /api/v1/english/words/{word_id}
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "id": 1,
        "word": "dog",
        "phonetic": "/dɒɡ/",
        "translation": "狗",
        "audio_us_url": "http://minio:9000/voicegrow/english/dog_us.mp3?X-Amz-...",
        "audio_uk_url": "http://minio:9000/voicegrow/english/dog_uk.mp3?X-Amz-...",
        "level": "basic",
        "category": "animal",
        "example_sentence": "The dog is running.",
        "example_translation": "狗在跑。"
    }
}
```

#### 3.4.3 随机获取单词

**请求:**

```http
GET /api/v1/english/words/random?level=basic&count=5
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "words": [
            {
                "id": 1,
                "word": "dog",
                "phonetic": "/dɒɡ/",
                "translation": "狗",
                "audio_us_url": "..."
            },
            {
                "id": 2,
                "word": "cat",
                "phonetic": "/kæt/",
                "translation": "猫",
                "audio_us_url": "..."
            }
        ]
    }
}
```

### 3.5 设备管理接口

#### 3.5.1 获取设备列表

**请求:**

```http
GET /api/v1/devices
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "devices": [
            {
                "device_id": "abc123",
                "device_model": "LX06",
                "is_connected": true,
                "last_connected_at": "2025-01-20T10:00:00Z",
                "playing_state": "playing",
                "current_content": {
                    "id": 1,
                    "title": "晚安小熊"
                }
            }
        ]
    }
}
```

#### 3.5.2 获取设备详情

**请求:**

```http
GET /api/v1/devices/{device_id}
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "device_id": "abc123",
        "device_model": "LX06",
        "device_sn": "SN123456",
        "is_connected": true,
        "last_connected_at": "2025-01-20T10:00:00Z",
        "last_disconnected_at": "2025-01-20T09:00:00Z",
        "playing_state": "playing",
        "current_content": {
            "id": 1,
            "title": "晚安小熊",
            "position": 60,
            "duration": 180
        },
        "session_data": {
            "context": "story",
            "history": ["play_story", "pause", "play"]
        }
    }
}
```

### 3.6 播放历史接口

#### 3.6.1 获取播放历史

**请求:**

```http
GET /api/v1/devices/{device_id}/history?page=1&size=20
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "items": [
            {
                "id": 1,
                "content": {
                    "id": 1,
                    "type": "story",
                    "title": "晚安小熊"
                },
                "played_at": "2025-01-20T10:00:00Z",
                "duration_played": 150,
                "completed": false
            }
        ],
        "total": 100,
        "page": 1,
        "size": 20
    }
}
```

### 3.7 统计接口

#### 3.7.1 获取播放统计

**请求:**

```http
GET /api/v1/stats/playback?device_id=abc123&start_date=2025-01-01&end_date=2025-01-31
```

**响应:**

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "total_play_count": 500,
        "total_play_duration": 36000,
        "by_type": {
            "story": { "count": 300, "duration": 24000 },
            "music": { "count": 150, "duration": 9000 },
            "english": { "count": 50, "duration": 3000 }
        },
        "by_day": [
            { "date": "2025-01-01", "count": 20, "duration": 1200 },
            { "date": "2025-01-02", "count": 25, "duration": 1500 }
        ]
    }
}
```

---

## 4. 外部服务接口

### 4.1 ai-manager TTS 接口

> 使用外部 **ai-manager** 项目的 TTS 服务，基于 Google Cloud Text-to-Speech。
> API 文档详见：`F:\develop\jingen\ai-manager\docs\api\tts-synthesize.md`

#### 4.1.1 接口配置

| 配置项 | 值 |
|--------|-----|
| 端点 | http://ai-manager:8000/api/v1/tts/synthesize |
| API版本 | v1 |
| 认证方式 | HMAC-SHA256 签名 |

#### 4.1.2 文本转语音请求

**请求头:**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | string | ✅ | application/json |
| X-API-Key | string | ✅ | API密钥 (ak_xxx) |
| X-Timestamp | string | ✅ | Unix时间戳（秒） |
| X-Signature | string | ✅ | HMAC-SHA256签名 |

**签名算法:**
```
HMAC-SHA256(SECRET_KEY, API_KEY + TIMESTAMP + HTTP_METHOD + PATH)
```

**请求体:**

```json
{
    "text": "好的，我来给你讲一个故事",
    "language_code": "zh-CN",
    "voice_name": "zh-CN-Neural2-C",
    "speaking_rate": 0.9,
    "pitch": 0.0,
    "audio_format": "mp3"
}
```

**SSML 请求示例:**

```json
{
    "text": "<speak>你好！<break time=\"300ms\"/><emphasis level=\"strong\">欢迎</emphasis>来到声伴成长。</speak>",
    "input_type": "ssml",
    "language_code": "zh-CN",
    "voice_name": "zh-CN-Neural2-C"
}
```

**响应:**

```json
{
    "audio_url": "https://minio.example.com/tts-audio/audio_abc123.mp3",
    "duration_ms": 2500,
    "character_count": 15,
    "is_cached": false,
    "voice_name": "zh-CN-Neural2-C",
    "language_code": "zh-CN",
    "audio_format": "mp3"
}
```

#### 4.1.3 支持的声音

| 声音名称 | 语言 | 风格 | 推荐场景 |
|----------|------|------|----------|
| zh-CN-Neural2-C | 中文 | 温和女声 | 儿童内容 (默认) |
| zh-CN-Neural2-D | 中文 | 阳光男声 | 故事讲述 |
| zh-CN-Wavenet-A | 中文 | 高品质女声 | 专业配音 |
| en-US-Neural2-C | 英语 | 标准美音女声 | 英语学习 |
| en-US-Neural2-D | 英语 | 标准美音男声 | 英语学习 |

#### 4.1.4 服务特性

| 特性 | 说明 |
|------|------|
| **永久缓存** | 相同参数组合只调用一次 Google TTS，后续返回缓存 |
| **多账户轮换** | 自动管理 Google TTS 配额，确保免费额度内运行 |
| **公开 URL** | 返回 MinIO URL，可直接播放，无需额外认证 |
| **SSML 支持** | 支持 `<break>`, `<emphasis>`, `<prosody>` 等标签 |

#### 4.1.5 配额说明

Google Cloud TTS 免费配额（每账户/月）：

| 类型 | 免费额度 |
|------|----------|
| 标准语音 | 400万字符 |
| WaveNet 语音 | 100万字符 |
| Neural2 语音 | 100万字符 |

系统通过多账户轮换自动管理配额，当主账户配额不足时自动切换备用账户。

### 4.2 ai-manager AI Prompt 接口

> 使用外部 **ai-manager** 项目的 AI Prompt API，支持多模型自动选择和智能缓存。
> API 文档详见：`F:\develop\jingen\ai-manager\docs\api\ai-services-prompt.md`

#### 4.2.1 接口配置

| 配置项 | 值 |
|--------|-----|
| 端点 | http://ai-manager:8000/api/v1/ai-services/prompt |
| API版本 | v1 |
| 认证方式 | HMAC-SHA256 签名 (与 TTS 共享) |

#### 4.2.2 对话请求

**请求头:**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | string | ✅ | application/json |
| X-API-Key | string | ✅ | API密钥 (ak_xxx) |
| X-Timestamp | string | ✅ | Unix时间戳（秒） |
| X-Signature | string | ✅ | HMAC-SHA256签名 |

**请求体:**

```json
{
    "prompt": "为什么天是蓝色的",
    "system_message": "你是一个儿童友好的AI助手，名字叫小声。回答要简洁有趣，适合3-12岁儿童理解。不超过100字。",
    "temperature": 0.7,
    "max_tokens": 300,
    "model_preference": "gemini-2.0-flash-exp"
}
```

**响应:**

```json
{
    "success": true,
    "message": "Prompt processed successfully",
    "data": {
        "prompt": "为什么天是蓝色的",
        "response": "这是因为阳光穿过空气时，蓝色的光更容易被散射开来，就像把一盒彩色弹珠撒出去，蓝色的弹珠跑得最远，所以我们看到的天空就是蓝色的啦！",
        "model_used": "gemini-2.0-flash-exp",
        "provider_name": "google",
        "cached": false,
        "usage": {
            "prompt_tokens": 50,
            "completion_tokens": 80,
            "total_tokens": 130
        },
        "response_time_ms": 1523.45
    }
}
```

#### 4.2.3 支持的模型

| 模型名称 | 提供商 | 特点 | 推荐场景 |
|---------|--------|------|---------|
| gemini-2.0-flash-exp | Google | 快速响应 | 日常对话 (默认) |
| gemini-2.5-flash | Google | 平衡性能 | 通用任务 |
| deepseek-chat | DeepSeek | 中文优化 | 中文对话 |
| gpt-4 | OpenAI | 高准确性 | 复杂问题 |
| gpt-3.5-turbo | OpenAI | 快速响应 | 简单对话 |

#### 4.2.4 服务特性

| 特性 | 说明 |
|------|------|
| **智能缓存** | 相同 prompt + system_message + temperature 命中缓存，零成本 |
| **多模型容错** | 支持最多10次重试，自动切换不同 Provider |
| **统一认证** | 与 TTS 服务共享 API Key/Secret Key |
| **Token 统计** | 返回 prompt/completion/total tokens 用于成本追踪 |

### 4.3 MinIO 接口

#### 4.3.1 接口配置

| 配置项 | 值 |
|--------|-----|
| 端点 | http://minio:9000 |
| Bucket | voicegrow |
| 认证方式 | Access Key / Secret Key |

#### 4.3.2 生成预签名URL

**Python SDK 调用:**

```python
from minio import Minio

client = Minio(
    "minio:9000",
    access_key="voicegrow",
    secret_key="voicegrow123",
    secure=False
)

# 生成下载URL (有效期1小时)
url = client.presigned_get_object(
    "voicegrow",
    "stories/story_001.mp3",
    expires=timedelta(hours=1)
)
```

**生成的URL格式:**

```
http://minio:9000/voicegrow/stories/story_001.mp3?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=...&X-Amz-Date=...&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=...
```

### 4.4 MySQL 接口

#### 4.4.1 连接配置

```python
DATABASE_URL = "mysql+asyncmy://voicegrow:password@mysql:3306/voicegrow"
```

#### 4.4.2 连接池配置

| 参数 | 值 | 说明 |
|------|-----|------|
| pool_size | 10 | 连接池大小 |
| max_overflow | 20 | 最大溢出连接 |
| pool_timeout | 30 | 获取连接超时(秒) |
| pool_recycle | 3600 | 连接回收时间(秒) |

### 4.5 Redis 接口

#### 4.5.1 连接配置

```python
REDIS_URL = "redis://redis:6379/0"
```

#### 4.5.2 主要操作

| 操作 | Key格式 | 说明 |
|------|---------|------|
| 设备会话 | device:{device_id}:session | Hash类型 |
| ASR缓存 | asr:{audio_hash} | String类型 |
| TTS缓存 | tts:{text_hash} | String类型 |
| 内容缓存 | content:{content_id} | String类型 |

---

## 5. 错误码定义

### 5.1 错误码分类

| 范围 | 分类 | 说明 |
|------|------|------|
| 0 | 成功 | 请求成功 |
| 1000-1999 | 客户端错误 | 请求参数、权限等问题 |
| 2000-2999 | 服务端错误 | 服务内部错误 |
| 3000-3999 | 外部服务错误 | 依赖服务异常 |
| 4000-4999 | 业务错误 | 业务逻辑限制 |

### 5.2 详细错误码

#### 5.2.1 客户端错误 (1000-1999)

| 错误码 | 名称 | 说明 |
|--------|------|------|
| 1001 | INVALID_PARAM | 参数无效 |
| 1002 | MISSING_PARAM | 缺少必填参数 |
| 1003 | INVALID_FORMAT | 数据格式错误 |
| 1004 | UNAUTHORIZED | 未授权访问 |
| 1005 | FORBIDDEN | 禁止访问 |
| 1006 | NOT_FOUND | 资源不存在 |
| 1007 | METHOD_NOT_ALLOWED | 方法不允许 |
| 1008 | REQUEST_TIMEOUT | 请求超时 |
| 1009 | RATE_LIMITED | 请求频率超限 |

#### 5.2.2 服务端错误 (2000-2999)

| 错误码 | 名称 | 说明 |
|--------|------|------|
| 2001 | INTERNAL_ERROR | 内部错误 |
| 2002 | SERVICE_UNAVAILABLE | 服务不可用 |
| 2003 | DATABASE_ERROR | 数据库错误 |
| 2004 | CACHE_ERROR | 缓存错误 |
| 2005 | CONFIG_ERROR | 配置错误 |

#### 5.2.3 外部服务错误 (3000-3999)

| 错误码 | 名称 | 说明 |
|--------|------|------|
| 3001 | ASR_ERROR | 语音识别错误 |
| 3002 | ASR_TIMEOUT | 语音识别超时 |
| 3003 | TTS_ERROR | 语音合成错误 |
| 3004 | TTS_TIMEOUT | 语音合成超时 |
| 3005 | LLM_ERROR | LLM调用错误 |
| 3006 | LLM_TIMEOUT | LLM调用超时 |
| 3007 | MINIO_ERROR | MinIO访问错误 |
| 3008 | MINIO_NOT_FOUND | MinIO资源不存在 |

#### 5.2.4 业务错误 (4000-4999)

| 错误码 | 名称 | 说明 |
|--------|------|------|
| 4001 | CONTENT_NOT_FOUND | 内容不存在 |
| 4002 | CONTENT_UNAVAILABLE | 内容不可用 |
| 4003 | DEVICE_NOT_CONNECTED | 设备未连接 |
| 4004 | DEVICE_BUSY | 设备忙碌 |
| 4005 | PLAYBACK_FAILED | 播放失败 |
| 4006 | INTENT_NOT_RECOGNIZED | 意图无法识别 |
| 4007 | CONTENT_SAFETY_BLOCKED | 内容安全拦截 |

### 5.3 错误响应格式

```json
{
    "code": 1001,
    "message": "Invalid parameter: type must be one of [story, music, english, sound]",
    "data": null,
    "timestamp": "2025-01-20T10:30:00.000Z",
    "request_id": "req_abc123",
    "error_detail": {
        "field": "type",
        "value": "invalid_type",
        "constraint": "enum"
    }
}
```

---

## 6. 接口安全

### 6.1 传输安全

| 场景 | 协议 | 说明 |
|------|------|------|
| 内网通信 | HTTP/WS | 内网环境可不加密 |
| 外网通信 | HTTPS/WSS | 必须使用TLS加密 |

### 6.2 设备认证

#### 6.2.1 认证流程

```
1. 设备连接时携带 device_id
2. 服务端验证 device_id 格式
3. 建立设备会话
4. 后续通信基于会话
```

#### 6.2.2 设备ID规范

| 属性 | 规范 |
|------|------|
| 格式 | 字母数字组合 |
| 长度 | 8-64字符 |
| 唯一性 | 全局唯一 |

### 6.3 请求限流

| 接口类型 | 限流规则 |
|----------|----------|
| WebSocket连接 | 每设备1个连接 |
| WebSocket消息 | 100消息/秒 |
| HTTP API | 100请求/分钟/IP |
| 内容下载 | 10请求/分钟/设备 |

### 6.4 内容安全

#### 6.4.1 输入过滤

- LLM输入文本长度限制 (500字符)
- 敏感词过滤
- SQL注入防护
- XSS防护

#### 6.4.2 输出过滤

- LLM输出内容安全检查
- 儿童友好内容验证
- 敏感信息脱敏

---

## 7. 接口版本管理

### 7.1 版本策略

| 策略 | 说明 |
|------|------|
| 版本格式 | v1, v2, v3... |
| 版本位置 | URL路径: /api/v1/... |
| 兼容性 | 同大版本向后兼容 |
| 废弃策略 | 提前3个月通知 |

### 7.2 版本演进

```
v1 (当前)
├── /api/v1/health
├── /api/v1/contents
├── /api/v1/english
├── /api/v1/devices
└── /api/v1/stats

v2 (规划中)
├── 新增用户系统
├── 新增收藏功能
└── 新增推荐系统
```

### 7.3 变更记录

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v1.0.0 | 2025-01 | 初始版本 |

---

## 附录

### A. 接口测试示例

#### A.1 WebSocket 测试 (Python)

```python
import asyncio
import websockets
import json

async def test_websocket():
    uri = "ws://localhost:4399/ws?device_id=test001"

    async with websockets.connect(uri) as ws:
        # 发送设备信息
        await ws.send(json.dumps({
            "type": "Event",
            "event": "device_info",
            "data": {
                "model": "LX06",
                "version": "1.0.0"
            }
        }))

        # 模拟唤醒
        await ws.send(json.dumps({
            "type": "Event",
            "event": "kws",
            "data": {"keyword": "小爱同学"}
        }))

        # 接收响应
        response = await ws.recv()
        print(f"Received: {response}")

asyncio.run(test_websocket())
```

#### A.2 HTTP API 测试 (curl)

```bash
# 健康检查
curl http://localhost:8000/api/v1/health

# 获取内容列表
curl "http://localhost:8000/api/v1/contents?type=story&page=1&size=10"

# 获取内容详情
curl http://localhost:8000/api/v1/contents/1

# 获取随机内容
curl "http://localhost:8000/api/v1/contents/random?type=story&category=bedtime"
```

### B. SDK 参考

#### B.1 Python SDK 使用示例

```python
from voicegrow_client import VoiceGrowClient

client = VoiceGrowClient("http://localhost:8000")

# 获取内容
contents = client.get_contents(type="story", category="bedtime")

# 获取设备状态
device = client.get_device("abc123")

# 控制播放
client.play_content("abc123", content_id=1)
client.pause("abc123")
```

### C. Postman 集合

提供 Postman 集合文件用于接口测试:
- `voicegrow_api.postman_collection.json`
- `voicegrow_environment.postman_environment.json`
