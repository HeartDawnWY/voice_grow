# VoiceGrow 部署设计文档

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| 1.0 | 2025-01 | VoiceGrow Team | 初始版本 |

---

## 目录

1. [部署概述](#1-部署概述)
2. [环境规划](#2-环境规划)
3. [Docker 部署](#3-docker-部署)
4. [服务配置](#4-服务配置)
5. [网络配置](#5-网络配置)
6. [数据管理](#6-数据管理)
7. [监控告警](#7-监控告警)
8. [运维操作](#8-运维操作)
9. [故障恢复](#9-故障恢复)

---

## 1. 部署概述

### 1.1 部署架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          VoiceGrow 部署架构                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Docker Host                               │   │
│  │                                                                  │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │   │
│  │  │   MySQL     │  │    Redis    │  │    MinIO    │              │   │
│  │  │   :3306     │  │    :6379    │  │  :9000/:9001│              │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │   │
│  │         │                │                │                      │   │
│  │         └────────────────┼────────────────┘                      │   │
│  │                          │                                       │   │
│  │                   ┌──────┴──────┐                                │   │
│  │                   │   Server    │                                │   │
│  │                   │ :4399/:8000 │                                │   │
│  │                   └──────┬──────┘                                │   │
│  │                          │                                       │   │
│  └──────────────────────────┼───────────────────────────────────────┘   │
│                             │                                           │
│                      ┌──────┴──────┐                                   │
│                      │  External   │                                   │
│                      │  Network    │                                   │
│                      └──────┬──────┘                                   │
│                             │                                           │
│  ┌──────────────────────────┼───────────────────────────────────────┐   │
│  │                          │                                       │   │
│  │  ┌─────────────┐   ┌─────┴─────┐   ┌─────────────┐              │   │
│  │  │ ai-manager  │   │  Xiaomi   │   │ ai-manager  │              │   │
│  │  │  TTS API    │   │  Speaker  │   │   LLM API   │              │   │
│  │  └─────────────┘   └───────────┘   └─────────────┘              │   │
│  │                                                                  │   │
│  │                    External Services                             │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 部署组件

| 组件 | 版本 | 端口 | 说明 |
|------|------|------|------|
| VoiceGrow Server | 1.0.0 | 4399, 8000 | 核心服务 |
| MySQL | 8.0 | 3306 | 数据存储 |
| Redis | 7.0 | 6379 | 会话缓存 |
| MinIO | latest | 9000, 9001 | 对象存储 |

### 1.3 硬件要求

#### 1.3.1 最小配置 (开发/测试)

| 资源 | 要求 |
|------|------|
| CPU | 4核 |
| 内存 | 8GB |
| 硬盘 | 50GB SSD |
| 网络 | 100Mbps |

#### 1.3.2 推荐配置 (生产)

| 资源 | 要求 |
|------|------|
| CPU | 8核+ |
| 内存 | 16GB+ |
| 硬盘 | 200GB+ SSD |
| 网络 | 1Gbps |

### 1.4 软件依赖

| 软件 | 版本要求 |
|------|----------|
| Docker | 24.0+ |
| Docker Compose | 2.20+ |
| 操作系统 | Ubuntu 22.04 / CentOS 8+ / Windows Server 2019+ |

---

## 2. 环境规划

### 2.1 环境分类

| 环境 | 用途 | 特点 |
|------|------|------|
| Development | 开发调试 | 本地运行, 调试模式 |
| Testing | 功能测试 | 隔离环境, 测试数据 |
| Staging | 预发布 | 生产配置, 验收测试 |
| Production | 生产环境 | 高可用, 监控告警 |

### 2.2 环境配置差异

```
┌─────────────┬──────────────┬──────────────┬──────────────┐
│    配置项    │ Development │   Testing    │  Production  │
├─────────────┼──────────────┼──────────────┼──────────────┤
│ DEBUG       │     True     │    False     │    False     │
│ LOG_LEVEL   │    DEBUG     │     INFO     │    WARNING   │
│ REPLICAS    │      1       │      1       │     2+       │
│ SSL         │     No       │     No       │     Yes      │
│ BACKUP      │     No       │    Daily     │   Hourly     │
│ MONITORING  │    Basic     │    Basic     │    Full      │
└─────────────┴──────────────┴──────────────┴──────────────┘
```

### 2.3 目录结构

```
/opt/voicegrow/
├── docker-compose.yml          # Docker Compose 配置
├── .env                        # 环境变量
├── config/
│   ├── mysql/
│   │   └── my.cnf              # MySQL 配置
│   ├── redis/
│   │   └── redis.conf          # Redis 配置
│   └── nginx/
│       └── nginx.conf          # Nginx 配置 (可选)
├── data/
│   ├── mysql/                  # MySQL 数据
│   ├── redis/                  # Redis 数据
│   └── minio/                  # MinIO 数据
├── logs/
│   ├── server/                 # 服务日志
│   ├── mysql/                  # MySQL 日志
│   └── nginx/                  # Nginx 日志
├── scripts/
│   ├── init.sql                # 数据库初始化
│   ├── backup.sh               # 备份脚本
│   └── deploy.sh               # 部署脚本
└── backup/
    ├── mysql/                  # MySQL 备份
    └── minio/                  # MinIO 备份
```

---

## 3. Docker 部署

### 3.1 docker-compose.yml

```yaml
version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: voicegrow-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123}
      MYSQL_DATABASE: voicegrow
      MYSQL_USER: voicegrow
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-voicegrow123}
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./logs/mysql:/var/log/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - voicegrow-net

  # Redis 缓存
  redis:
    image: redis:7.0-alpine
    container_name: voicegrow-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - voicegrow-net

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: voicegrow-minio
    restart: always
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-voicegrow}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-voicegrow123}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./data/minio:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - voicegrow-net

  # VoiceGrow 服务
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: voicegrow-server
    restart: always
    environment:
      # 服务配置
      SERVER_HOST: 0.0.0.0
      WS_PORT: 4399
      HTTP_PORT: 8000
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # ASR 配置
      ASR_MODEL_SIZE: ${ASR_MODEL_SIZE:-small}
      ASR_DEVICE: ${ASR_DEVICE:-cpu}
      ASR_COMPUTE_TYPE: ${ASR_COMPUTE_TYPE:-int8}

      # TTS 配置 (使用外部 ai-manager 服务)
      TTS_BASE_URL: ${TTS_BASE_URL:-http://ai-manager:8000}
      TTS_API_KEY: ${TTS_API_KEY}
      TTS_SECRET_KEY: ${TTS_SECRET_KEY}
      TTS_VOICE_ZH: ${TTS_VOICE_ZH:-zh-CN-Neural2-C}
      TTS_VOICE_EN: ${TTS_VOICE_EN:-en-US-Neural2-C}
      TTS_SPEAKING_RATE: ${TTS_SPEAKING_RATE:-0.9}

      # LLM 配置 (使用外部 ai-manager 服务，与 TTS 共享认证)
      LLM_BASE_URL: ${LLM_BASE_URL:-http://ai-manager:8000}
      LLM_API_KEY: ${LLM_API_KEY}
      LLM_SECRET_KEY: ${LLM_SECRET_KEY}
      LLM_MODEL: ${LLM_MODEL:-gemini-2.0-flash-exp}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS:-300}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE:-0.7}

      # 数据库配置
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_DATABASE: voicegrow
      MYSQL_USER: voicegrow
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-voicegrow123}

      # Redis 配置
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # MinIO 配置
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-voicegrow}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-voicegrow123}
      MINIO_BUCKET: voicegrow
      MINIO_SECURE: "false"
    ports:
      - "4399:4399"
      - "8000:8000"
    volumes:
      - ./logs/server:/app/logs
      - ./data/models:/app/models
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - voicegrow-net

networks:
  voicegrow-net:
    driver: bridge
```

### 3.2 Server Dockerfile

```dockerfile
# VoiceGrow Server Dockerfile
FROM python:3.10-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    libffi-dev \
    libssl-dev \
    ffmpeg \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY app/ ./app/

# 创建日志目录
RUN mkdir -p /app/logs /app/models

# 设置环境变量
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# 暴露端口
EXPOSE 4399 8000

# 启动命令
CMD ["python", "-m", "app.main"]
```

### 3.3 配置文件

#### 3.3.1 MySQL 配置 (config/mysql/my.cnf)

```ini
[mysqld]
# 基础配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
default-time-zone = '+08:00'

# 性能优化
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# 连接配置
max_connections = 200
wait_timeout = 600
interactive_timeout = 600

# 日志配置
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_error = /var/log/mysql/error.log

# 安全配置
skip-name-resolve
sql_mode = STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION

[client]
default-character-set = utf8mb4
```

#### 3.3.2 Redis 配置 (config/redis/redis.conf)

```conf
# 基础配置
bind 0.0.0.0
port 6379
daemonize no

# 持久化
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfsync everysec

# 内存管理
maxmemory 512mb
maxmemory-policy allkeys-lru

# 日志
loglevel notice
logfile ""

# 连接
timeout 0
tcp-keepalive 300
maxclients 1000
```

### 3.4 环境变量文件 (.env)

```bash
# ========================================
# VoiceGrow Environment Configuration
# ========================================

# 环境标识
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=INFO

# ========================================
# 数据库配置
# ========================================
MYSQL_ROOT_PASSWORD=your_root_password_here
MYSQL_PASSWORD=your_password_here

# ========================================
# Redis 配置
# ========================================
REDIS_PASSWORD=

# ========================================
# MinIO 配置
# ========================================
MINIO_ACCESS_KEY=voicegrow
MINIO_SECRET_KEY=your_minio_secret_here

# ========================================
# ASR 配置
# ========================================
ASR_MODEL_SIZE=small
ASR_DEVICE=cpu
ASR_COMPUTE_TYPE=int8

# ========================================
# TTS 配置 (使用外部 ai-manager 服务)
# ========================================
TTS_BASE_URL=http://ai-manager:8000
TTS_API_KEY=ak_your_api_key_here
TTS_SECRET_KEY=sk_your_secret_key_here
TTS_VOICE_ZH=zh-CN-Neural2-C
TTS_VOICE_EN=en-US-Neural2-C
TTS_SPEAKING_RATE=0.9

# ========================================
# LLM 配置 (使用外部 ai-manager 服务)
# 注意: 可与 TTS 共享同一组 API Key
# ========================================
LLM_BASE_URL=http://ai-manager:8000
LLM_API_KEY=ak_your_api_key_here
LLM_SECRET_KEY=sk_your_secret_key_here
LLM_MODEL=gemini-2.0-flash-exp
LLM_MAX_TOKENS=300
LLM_TEMPERATURE=0.7
```

---

## 4. 服务配置

### 4.1 服务参数

#### 4.1.1 Server 配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| SERVER_HOST | 0.0.0.0 | 监听地址 |
| WS_PORT | 4399 | WebSocket 端口 |
| HTTP_PORT | 8000 | HTTP API 端口 |
| DEBUG | false | 调试模式 |
| LOG_LEVEL | INFO | 日志级别 |
| WORKERS | 1 | 工作进程数 |

#### 4.1.2 ASR 配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| ASR_MODEL_SIZE | small | 模型大小: tiny/base/small/medium/large |
| ASR_DEVICE | cpu | 计算设备: cpu/cuda |
| ASR_COMPUTE_TYPE | int8 | 计算精度: int8/float16/float32 |
| ASR_LANGUAGE | zh | 识别语言 |
| ASR_TIMEOUT | 30 | 超时时间(秒) |

#### 4.1.3 TTS 配置 (ai-manager 服务)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| TTS_BASE_URL | http://ai-manager:8000 | ai-manager 服务地址 |
| TTS_API_KEY | - | API密钥 (ak_xxx) |
| TTS_SECRET_KEY | - | 签名密钥 (sk_xxx) |
| TTS_VOICE_ZH | zh-CN-Neural2-C | 中文语音 (温和女声) |
| TTS_VOICE_EN | en-US-Neural2-C | 英文语音 |
| TTS_SPEAKING_RATE | 0.9 | 语速 (0.25-4.0) |
| TTS_PITCH | 0.0 | 音调 (-20.0 到 20.0) |
| TTS_TIMEOUT | 30 | 请求超时(秒) |

> **注意**: TTS API Key 需从 ai-manager 服务获取，详见 `F:\develop\jingen\ai-manager\docs\api\tts-accounts.md`

#### 4.1.4 LLM 配置 (ai-manager 服务)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| LLM_BASE_URL | http://ai-manager:8000 | ai-manager 服务地址 |
| LLM_API_KEY | - | API密钥 (ak_xxx)，可与 TTS 共享 |
| LLM_SECRET_KEY | - | 签名密钥 (sk_xxx)，可与 TTS 共享 |
| LLM_MODEL | gemini-2.0-flash-exp | 首选模型 |
| LLM_MAX_TOKENS | 300 | 最大输出 token |
| LLM_TEMPERATURE | 0.7 | 生成温度 (0.0-2.0) |
| LLM_TIMEOUT | 30 | 请求超时(秒) |

> **提示**: LLM 和 TTS 服务可共享同一组 API Key/Secret Key，简化配置管理。

### 4.2 资源限制

```yaml
# docker-compose.yml 中添加资源限制
services:
  server:
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G

  mysql:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  redis:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  minio:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M
```

---

## 5. 网络配置

### 5.1 端口规划

| 服务 | 内部端口 | 外部端口 | 协议 | 说明 |
|------|----------|----------|------|------|
| Server (WS) | 4399 | 4399 | TCP | WebSocket 通信 |
| Server (HTTP) | 8000 | 8000 | TCP | HTTP API |
| MySQL | 3306 | 3306 | TCP | 数据库 (可限制) |
| Redis | 6379 | 6379 | TCP | 缓存 (可限制) |
| MinIO (API) | 9000 | 9000 | TCP | 对象存储 |
| MinIO (Console) | 9001 | 9001 | TCP | 管理控制台 |

### 5.2 防火墙配置

#### 5.2.1 Linux (iptables)

```bash
#!/bin/bash

# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 允许 SSH
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 允许 VoiceGrow 服务端口
iptables -A INPUT -p tcp --dport 4399 -j ACCEPT  # WebSocket
iptables -A INPUT -p tcp --dport 8000 -j ACCEPT  # HTTP API
iptables -A INPUT -p tcp --dport 9000 -j ACCEPT  # MinIO API
iptables -A INPUT -p tcp --dport 9001 -j ACCEPT  # MinIO Console

# 内网访问数据库 (限制来源)
iptables -A INPUT -p tcp --dport 3306 -s 192.168.0.0/16 -j ACCEPT
iptables -A INPUT -p tcp --dport 6379 -s 192.168.0.0/16 -j ACCEPT

# 默认拒绝
iptables -A INPUT -j DROP

# 保存规则
iptables-save > /etc/iptables/rules.v4
```

#### 5.2.2 Windows (Windows Firewall)

```powershell
# 允许 VoiceGrow 服务端口
New-NetFirewallRule -DisplayName "VoiceGrow WebSocket" -Direction Inbound -Protocol TCP -LocalPort 4399 -Action Allow
New-NetFirewallRule -DisplayName "VoiceGrow HTTP API" -Direction Inbound -Protocol TCP -LocalPort 8000 -Action Allow
New-NetFirewallRule -DisplayName "MinIO API" -Direction Inbound -Protocol TCP -LocalPort 9000 -Action Allow
New-NetFirewallRule -DisplayName "MinIO Console" -Direction Inbound -Protocol TCP -LocalPort 9001 -Action Allow
```

### 5.3 反向代理配置 (可选)

#### 5.3.1 Nginx 配置

```nginx
# /etc/nginx/conf.d/voicegrow.conf

upstream voicegrow_ws {
    server 127.0.0.1:4399;
}

upstream voicegrow_api {
    server 127.0.0.1:8000;
}

# WebSocket 服务
server {
    listen 443 ssl;
    server_name ws.voicegrow.example.com;

    ssl_certificate /etc/nginx/ssl/voicegrow.crt;
    ssl_certificate_key /etc/nginx/ssl/voicegrow.key;

    location / {
        proxy_pass http://voicegrow_ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400;
    }
}

# HTTP API 服务
server {
    listen 443 ssl;
    server_name api.voicegrow.example.com;

    ssl_certificate /etc/nginx/ssl/voicegrow.crt;
    ssl_certificate_key /etc/nginx/ssl/voicegrow.key;

    location / {
        proxy_pass http://voicegrow_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## 6. 数据管理

### 6.1 数据备份

#### 6.1.1 MySQL 备份脚本

```bash
#!/bin/bash
# scripts/backup_mysql.sh

# 配置
BACKUP_DIR="/opt/voicegrow/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_CONTAINER="voicegrow-mysql"
MYSQL_USER="root"
MYSQL_PASSWORD="${MYSQL_ROOT_PASSWORD}"
RETENTION_DAYS=7

# 创建备份目录
mkdir -p ${BACKUP_DIR}

# 执行备份
docker exec ${MYSQL_CONTAINER} mysqldump \
    -u${MYSQL_USER} \
    -p${MYSQL_PASSWORD} \
    --single-transaction \
    --routines \
    --triggers \
    voicegrow > ${BACKUP_DIR}/voicegrow_${DATE}.sql

# 压缩备份
gzip ${BACKUP_DIR}/voicegrow_${DATE}.sql

# 清理旧备份
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +${RETENTION_DAYS} -delete

echo "Backup completed: ${BACKUP_DIR}/voicegrow_${DATE}.sql.gz"
```

#### 6.1.2 MinIO 备份脚本

```bash
#!/bin/bash
# scripts/backup_minio.sh

# 配置
BACKUP_DIR="/opt/voicegrow/backup/minio"
DATE=$(date +%Y%m%d_%H%M%S)
MINIO_DATA="/opt/voicegrow/data/minio"
RETENTION_DAYS=7

# 创建备份目录
mkdir -p ${BACKUP_DIR}

# 执行备份 (增量)
tar -czf ${BACKUP_DIR}/minio_${DATE}.tar.gz \
    -C ${MINIO_DATA} .

# 清理旧备份
find ${BACKUP_DIR} -name "*.tar.gz" -mtime +${RETENTION_DAYS} -delete

echo "Backup completed: ${BACKUP_DIR}/minio_${DATE}.tar.gz"
```

#### 6.1.3 定时备份 (crontab)

```bash
# 每天凌晨 2:00 备份 MySQL
0 2 * * * /opt/voicegrow/scripts/backup_mysql.sh >> /opt/voicegrow/logs/backup.log 2>&1

# 每周日凌晨 3:00 备份 MinIO
0 3 * * 0 /opt/voicegrow/scripts/backup_minio.sh >> /opt/voicegrow/logs/backup.log 2>&1
```

### 6.2 数据恢复

#### 6.2.1 MySQL 恢复

```bash
#!/bin/bash
# scripts/restore_mysql.sh

BACKUP_FILE=$1
MYSQL_CONTAINER="voicegrow-mysql"
MYSQL_USER="root"
MYSQL_PASSWORD="${MYSQL_ROOT_PASSWORD}"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file.sql.gz>"
    exit 1
fi

# 解压备份
gunzip -c ${BACKUP_FILE} > /tmp/restore.sql

# 停止服务
docker-compose stop server

# 恢复数据
docker exec -i ${MYSQL_CONTAINER} mysql \
    -u${MYSQL_USER} \
    -p${MYSQL_PASSWORD} \
    voicegrow < /tmp/restore.sql

# 清理临时文件
rm /tmp/restore.sql

# 启动服务
docker-compose start server

echo "Restore completed from: ${BACKUP_FILE}"
```

### 6.3 数据迁移

#### 6.3.1 导出数据

```bash
# 导出 MySQL 数据
docker exec voicegrow-mysql mysqldump \
    -uroot -p${MYSQL_ROOT_PASSWORD} \
    voicegrow > voicegrow_export.sql

# 导出 MinIO 数据
docker run --rm \
    -v /opt/voicegrow/data/minio:/data \
    -v $(pwd):/backup \
    alpine tar -czf /backup/minio_export.tar.gz -C /data .
```

#### 6.3.2 导入数据

```bash
# 导入 MySQL 数据
docker exec -i voicegrow-mysql mysql \
    -uroot -p${MYSQL_ROOT_PASSWORD} \
    voicegrow < voicegrow_export.sql

# 导入 MinIO 数据
docker run --rm \
    -v /opt/voicegrow/data/minio:/data \
    -v $(pwd):/backup \
    alpine tar -xzf /backup/minio_export.tar.gz -C /data
```

---

## 7. 监控告警

### 7.1 监控架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        监控系统架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │  Services   │ ──> │ Prometheus  │ ──> │   Grafana   │       │
│  │  (Metrics)  │     │             │     │             │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│                             │                                   │
│                             ▼                                   │
│                      ┌─────────────┐                           │
│                      │ AlertManager│ ──> 邮件/钉钉/企微         │
│                      └─────────────┘                           │
│                                                                 │
│  ┌─────────────┐     ┌─────────────┐                           │
│  │  Services   │ ──> │   Loki      │ ──> 日志查询/告警          │
│  │   (Logs)    │     │             │                           │
│  └─────────────┘     └─────────────┘                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 健康检查

#### 7.2.1 服务健康检查脚本

```bash
#!/bin/bash
# scripts/healthcheck.sh

# 检查 Server
SERVER_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/health)
if [ "$SERVER_HEALTH" != "200" ]; then
    echo "ERROR: Server health check failed"
    exit 1
fi

# 检查 MySQL
MYSQL_HEALTH=$(docker exec voicegrow-mysql mysqladmin ping -h localhost 2>/dev/null)
if [ "$MYSQL_HEALTH" != "mysqld is alive" ]; then
    echo "ERROR: MySQL health check failed"
    exit 1
fi

# 检查 Redis
REDIS_HEALTH=$(docker exec voicegrow-redis redis-cli ping 2>/dev/null)
if [ "$REDIS_HEALTH" != "PONG" ]; then
    echo "ERROR: Redis health check failed"
    exit 1
fi

# 检查 MinIO
MINIO_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9000/minio/health/live)
if [ "$MINIO_HEALTH" != "200" ]; then
    echo "ERROR: MinIO health check failed"
    exit 1
fi

echo "All services are healthy"
exit 0
```

### 7.3 关键指标

| 指标类型 | 指标名称 | 告警阈值 |
|----------|----------|----------|
| 系统资源 | CPU 使用率 | > 80% |
| 系统资源 | 内存使用率 | > 85% |
| 系统资源 | 磁盘使用率 | > 90% |
| 服务状态 | 服务可用性 | < 99.9% |
| 服务状态 | 响应时间 | > 3s |
| 业务指标 | ASR 成功率 | < 95% |
| 业务指标 | TTS 成功率 | < 99% |
| 业务指标 | 并发连接数 | > 100 |

### 7.4 日志管理

#### 7.4.1 日志配置

```python
# app/core/logging.py

import logging
import json
from datetime import datetime

class JSONFormatter(logging.Formatter):
    def format(self, record):
        log_record = {
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno
        }
        if record.exc_info:
            log_record["exception"] = self.formatException(record.exc_info)
        return json.dumps(log_record, ensure_ascii=False)

def setup_logging(level: str = "INFO"):
    handler = logging.StreamHandler()
    handler.setFormatter(JSONFormatter())

    logging.basicConfig(
        level=getattr(logging, level),
        handlers=[handler]
    )
```

#### 7.4.2 日志轮转

```yaml
# docker-compose.yml 中添加日志配置
services:
  server:
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
```

---

## 8. 运维操作

### 8.1 部署流程

#### 8.1.1 首次部署

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

echo "=== VoiceGrow Deployment ==="

# 1. 创建目录结构
echo "Creating directories..."
mkdir -p /opt/voicegrow/{config/{mysql,redis,nginx},data/{mysql,redis,minio,models},logs/{server,mysql},scripts,backup/{mysql,minio}}

# 2. 复制配置文件
echo "Copying configuration files..."
cp docker-compose.yml /opt/voicegrow/
cp .env.example /opt/voicegrow/.env
cp -r config/* /opt/voicegrow/config/
cp -r scripts/* /opt/voicegrow/scripts/
cp -r server /opt/voicegrow/

# 3. 设置权限
echo "Setting permissions..."
chmod +x /opt/voicegrow/scripts/*.sh
chmod 600 /opt/voicegrow/.env

# 4. 编辑配置
echo "Please edit /opt/voicegrow/.env with your settings"
read -p "Press Enter after editing .env..."

# 5. 启动服务
echo "Starting services..."
cd /opt/voicegrow
docker-compose pull
docker-compose up -d

# 6. 等待服务就绪
echo "Waiting for services to be ready..."
sleep 30

# 7. 初始化 MinIO Bucket
echo "Initializing MinIO bucket..."
docker exec voicegrow-minio mc alias set local http://localhost:9000 voicegrow voicegrow123
docker exec voicegrow-minio mc mb local/voicegrow --ignore-existing

# 8. 验证部署
echo "Verifying deployment..."
/opt/voicegrow/scripts/healthcheck.sh

echo "=== Deployment Complete ==="
```

#### 8.1.2 更新部署

```bash
#!/bin/bash
# scripts/update.sh

set -e

echo "=== VoiceGrow Update ==="

cd /opt/voicegrow

# 1. 备份
echo "Creating backup..."
./scripts/backup_mysql.sh

# 2. 拉取最新镜像
echo "Pulling latest images..."
docker-compose pull

# 3. 重启服务
echo "Restarting services..."
docker-compose up -d --build server

# 4. 验证
echo "Verifying update..."
sleep 10
./scripts/healthcheck.sh

echo "=== Update Complete ==="
```

### 8.2 常用命令

#### 8.2.1 服务管理

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 重启单个服务
docker-compose restart server

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f server

# 进入容器
docker exec -it voicegrow-server bash
docker exec -it voicegrow-mysql mysql -uroot -p
docker exec -it voicegrow-redis redis-cli
```

#### 8.2.2 故障排查

```bash
# 检查服务健康
curl http://localhost:8000/api/v1/health/detail

# 检查容器资源使用
docker stats

# 检查网络连接
docker network inspect voicegrow_voicegrow-net

# 检查磁盘使用
df -h
docker system df

# 清理无用资源
docker system prune -a
```

### 8.3 扩容方案

#### 8.3.1 水平扩容

```yaml
# docker-compose.scale.yml
version: '3.8'

services:
  server:
    deploy:
      replicas: 3

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - server
```

---

## 9. 故障恢复

### 9.1 故障场景

| 故障类型 | 影响范围 | 恢复优先级 | 恢复时间目标 |
|----------|----------|------------|--------------|
| Server 崩溃 | 服务不可用 | 高 | 5分钟 |
| MySQL 崩溃 | 数据服务不可用 | 高 | 10分钟 |
| Redis 崩溃 | 缓存失效 | 中 | 5分钟 |
| MinIO 崩溃 | 音频无法播放 | 中 | 10分钟 |
| 网络故障 | 设备无法连接 | 高 | 根据情况 |

### 9.2 恢复流程

#### 9.2.1 Server 恢复

```bash
# 1. 检查容器状态
docker ps -a | grep voicegrow-server

# 2. 查看错误日志
docker logs voicegrow-server --tail 100

# 3. 重启服务
docker-compose restart server

# 4. 如果重启失败，重建容器
docker-compose up -d --force-recreate server

# 5. 验证恢复
curl http://localhost:8000/api/v1/health
```

#### 9.2.2 MySQL 恢复

```bash
# 1. 检查容器状态
docker ps -a | grep voicegrow-mysql

# 2. 查看错误日志
docker logs voicegrow-mysql --tail 100

# 3. 尝试重启
docker-compose restart mysql

# 4. 如果数据损坏，从备份恢复
./scripts/restore_mysql.sh /opt/voicegrow/backup/mysql/latest.sql.gz

# 5. 验证恢复
docker exec voicegrow-mysql mysqladmin ping -h localhost
```

#### 9.2.3 完整恢复流程

```bash
#!/bin/bash
# scripts/disaster_recovery.sh

echo "=== Disaster Recovery ==="

# 1. 停止所有服务
echo "Stopping all services..."
docker-compose down

# 2. 清理数据目录 (如果需要)
read -p "Clear data directories? (y/n) " -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]; then
    rm -rf /opt/voicegrow/data/*
fi

# 3. 重新启动基础服务
echo "Starting infrastructure..."
docker-compose up -d mysql redis minio

# 4. 等待基础服务就绪
echo "Waiting for infrastructure..."
sleep 30

# 5. 恢复 MySQL 数据
echo "Restoring MySQL..."
LATEST_BACKUP=$(ls -t /opt/voicegrow/backup/mysql/*.sql.gz | head -1)
./scripts/restore_mysql.sh $LATEST_BACKUP

# 6. 恢复 MinIO 数据
echo "Restoring MinIO..."
LATEST_MINIO=$(ls -t /opt/voicegrow/backup/minio/*.tar.gz | head -1)
tar -xzf $LATEST_MINIO -C /opt/voicegrow/data/minio

# 7. 启动应用服务
echo "Starting application..."
docker-compose up -d server

# 8. 验证恢复
echo "Verifying recovery..."
sleep 10
./scripts/healthcheck.sh

echo "=== Recovery Complete ==="
```

### 9.3 应急联系

| 角色 | 责任 | 联系方式 |
|------|------|----------|
| 运维负责人 | 基础设施问题 | ops@example.com |
| 开发负责人 | 应用问题 | dev@example.com |
| DBA | 数据库问题 | dba@example.com |

---

## 附录

### A. 检查清单

#### A.1 部署前检查

- [ ] 硬件资源满足要求
- [ ] Docker 和 Docker Compose 已安装
- [ ] 网络端口可用 (4399, 8000, 3306, 6379, 9000, 9001)
- [ ] 环境变量已正确配置
- [ ] ai-manager TTS API Key 有效
- [ ] ai-manager LLM API Key 有效

#### A.2 部署后检查

- [ ] 所有容器正常运行
- [ ] 健康检查通过
- [ ] WebSocket 连接正常
- [ ] HTTP API 可访问
- [ ] MinIO 控制台可访问
- [ ] 日志正常输出

### B. 常见问题

#### B.1 容器无法启动

```bash
# 检查日志
docker-compose logs <service_name>

# 检查资源
docker system df
free -h
df -h
```

#### B.2 网络连接问题

```bash
# 检查网络
docker network ls
docker network inspect voicegrow_voicegrow-net

# 检查端口
netstat -tlnp | grep -E "4399|8000|3306|6379|9000"
```

#### B.3 性能问题

```bash
# 检查容器资源使用
docker stats

# 检查系统负载
top
htop

# 检查 IO
iostat -x 1
```

### C. 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2025-01 | 初始版本 |
