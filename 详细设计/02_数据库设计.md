# VoiceGrow 数据库设计文档

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| 1.0 | 2025-01 | VoiceGrow Team | 初始版本 |
| 1.1 | 2025-01 | VoiceGrow Team | 重构分类、新增艺术家和标签体系 |

---

## 目录

1. [技术栈](#1-技术栈)
2. [设计概述](#2-设计概述)
3. [ER 图](#3-er-图)
4. [表结构设计](#4-表结构设计)
5. [索引设计](#5-索引设计)
6. [查询场景设计](#6-查询场景设计)
7. [MinIO 存储设计](#7-minio-存储设计)
8. [Redis 缓存设计](#8-redis-缓存设计)
9. [数据维护](#9-数据维护)

---

## 1. 技术栈

### 1.1 数据存储技术栈

| 组件 | 技术选型 | 版本 | 用途 |
|------|----------|------|------|
| 关系数据库 | MySQL | 8.0+ | 结构化数据存储（内容元数据、分类、标签等）|
| 对象存储 | MinIO | latest | 音频文件、封面图片等二进制文件存储 |
| 缓存数据库 | Redis | 7.0+ | 会话缓存、热点数据缓存、ASR/TTS结果缓存 |

### 1.2 数据访问技术栈

| 组件 | 技术选型 | 版本 | 用途 |
|------|----------|------|------|
| ORM框架 | SQLAlchemy | 2.0+ | Python ORM，支持异步 |
| 异步驱动 | asyncmy | 0.2+ | MySQL 异步驱动 |
| 连接池 | SQLAlchemy Pool | - | 数据库连接池管理 |
| Redis客户端 | redis-py | 5.0+ | Redis 异步客户端 |
| MinIO客户端 | minio-py | 7.2+ | MinIO Python SDK |

### 1.3 技术选型理由

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据存储架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      Application                         │   │
│  │                  (FastAPI + SQLAlchemy)                  │   │
│  └─────────────────────────┬───────────────────────────────┘   │
│                            │                                    │
│           ┌────────────────┼────────────────┐                  │
│           │                │                │                   │
│           ▼                ▼                ▼                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   MySQL     │  │    Redis    │  │    MinIO    │            │
│  │   8.0+      │  │    7.0+     │  │   latest    │            │
│  │             │  │             │  │             │            │
│  │ • 内容元数据 │  │ • 会话缓存  │  │ • 音频文件  │            │
│  │ • 分类体系   │  │ • 热点数据  │  │ • 封面图片  │            │
│  │ • 标签系统   │  │ • ASR缓存   │  │ • TTS缓存   │            │
│  │ • 艺术家    │  │ • TTS缓存   │  │             │            │
│  │ • 播放历史  │  │             │  │             │            │
│  │             │  │             │  │             │            │
│  │ 选型理由:   │  │ 选型理由:   │  │ 选型理由:   │            │
│  │ • 成熟稳定  │  │ • 高性能    │  │ • S3兼容    │            │
│  │ • 事务支持  │  │ • 丰富数据  │  │ • 自托管    │            │
│  │ • 复杂查询  │  │   结构      │  │ • 低成本    │            │
│  │ • 生态丰富  │  │ • 过期策略  │  │ • 易扩展    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.4 数据库配置

```yaml
MySQL:
  host: localhost (开发) / mysql (Docker)
  port: 3306
  database: voicegrow
  charset: utf8mb4
  collation: utf8mb4_unicode_ci
  pool_size: 10
  max_overflow: 20

MinIO:
  endpoint: localhost:9000 (开发) / minio:9000 (Docker)
  bucket: voicegrow
  secure: false
  access_key: voicegrow
  secret_key: voicegrow123

Redis:
  host: localhost (开发) / redis (Docker)
  port: 6379
  db: 0
  max_connections: 50
```

---

## 2. 设计概述

### 2.1 核心设计原则

1. **分类层级化**: 支持多级分类树（故事→童话故事→格林童话）
2. **标签灵活化**: 支持多标签组合查询（胎教+故事、少儿+英语）
3. **艺术家独立**: 支持按歌手/作者/讲述者查询（王力宏、凯叔）
4. **查询高效化**: 针对语音指令场景优化索引设计
5. **拼音搜索**: 支持拼音模糊匹配，提升ASR识别后的查询准确性

### 2.2 表概览

| 表名 | 说明 | 主要用途 |
|------|------|----------|
| **categories** | 分类表 | 层级分类管理（故事、音乐、英语等）|
| **artists** | 艺术家表 | 歌手、作者、讲述者等 |
| **tags** | 标签表 | 灵活标签（胎教、睡前、经典等）|
| **contents** | 内容表 | 音频内容主表 |
| **content_artists** | 内容-艺术家关联 | 多对多关系 |
| **content_tags** | 内容-标签关联 | 多对多关系 |
| **english_words** | 英语单词表 | 英语学习专用 |
| **play_history** | 播放历史表 | 用户播放记录 |
| **device_sessions** | 设备会话表 | 设备连接状态 |

### 2.3 查询场景支持

| 用户指令示例 | 查询方式 | 涉及表 |
|--------------|----------|--------|
| "讲个故事" | 按type查询 | contents |
| "播放童话故事" | 按category查询 | contents + categories |
| "想听王力宏的歌" | 按artist查询 | contents + artists + content_artists |
| "播放胎教故事" | 按tag+type查询 | contents + tags + content_tags |
| "播放少儿英语故事" | 按多tag组合查询 | contents + tags + content_tags |
| "播放睡前音乐" | 按tag+type查询 | contents + tags + content_tags |
| "播放周杰伦的晴天" | 按artist+title查询 | contents + artists + content_artists |
| "学习动物单词" | 按category查询 | english_words + categories |

---

## 3. ER 图

### 3.1 核心实体关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              VoiceGrow ER 图                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐         ┌─────────────────────┐         ┌─────────────┐   │
│  │ categories  │         │      contents       │         │   artists   │   │
│  ├─────────────┤         ├─────────────────────┤         ├─────────────┤   │
│  │ id (PK)     │    1    │ id (PK)             │    N    │ id (PK)     │   │
│  │ parent_id   │◄────────│ category_id (FK)    │────────►│ name        │   │
│  │ name        │    N    │ type                │         │ name_pinyin │   │
│  │ name_pinyin │         │ title               │         │ aliases     │   │
│  │ type        │         │ title_pinyin        │         │ type        │   │
│  │ level       │         │ description         │         │ avatar_path │   │
│  │ path        │         │ minio_path          │         │ description │   │
│  │ sort_order  │         │ cover_path          │         └──────┬──────┘   │
│  │ icon        │         │ duration            │                │          │
│  └──────┬──────┘         │ ...                 │                │          │
│         │                └──────────┬──────────┘                │          │
│         │                           │                           │          │
│         │ (self-ref)                │                           │          │
│         └────────┐                  │                           │          │
│                  ▼                  │                           │          │
│         ┌─────────────┐            │                           │          │
│         │  (子分类)    │            │                           │          │
│         └─────────────┘            │                           │          │
│                                    │                           │          │
│                          ┌─────────┴─────────┐                 │          │
│                          │                   │                 │          │
│                          ▼                   ▼                 ▼          │
│                 ┌─────────────────┐ ┌─────────────────────────────┐       │
│                 │  content_tags   │ │     content_artists         │       │
│                 ├─────────────────┤ ├─────────────────────────────┤       │
│                 │ content_id (FK) │ │ content_id (FK)             │       │
│                 │ tag_id (FK)     │ │ artist_id (FK)              │       │
│                 └────────┬────────┘ │ role (singer/author/narrator)│       │
│                          │          └─────────────────────────────┘       │
│                          │                                                │
│                          ▼                                                │
│                 ┌─────────────┐                                           │
│                 │    tags     │                                           │
│                 ├─────────────┤                                           │
│                 │ id (PK)     │                                           │
│                 │ name        │                                           │
│                 │ name_pinyin │                                           │
│                 │ type        │                                           │
│                 │ sort_order  │                                           │
│                 └─────────────┘                                           │
│                                                                           │
│  ┌─────────────────┐         ┌─────────────────┐                         │
│  │  play_history   │         │ device_sessions │                         │
│  ├─────────────────┤         ├─────────────────┤                         │
│  │ id (PK)         │         │ id (PK)         │                         │
│  │ device_id       │         │ device_id       │                         │
│  │ content_id (FK) │────────►│ device_model    │                         │
│  │ played_at       │         │ is_connected    │                         │
│  │ duration_played │         │ playing_state   │                         │
│  │ completed       │         │ current_content │                         │
│  └─────────────────┘         └─────────────────┘                         │
│                                                                           │
│  ┌─────────────────┐                                                     │
│  │ english_words   │                                                     │
│  ├─────────────────┤                                                     │
│  │ id (PK)         │                                                     │
│  │ word            │                                                     │
│  │ phonetic        │                                                     │
│  │ translation     │                                                     │
│  │ category_id(FK) │─────────► categories                                │
│  │ level           │                                                     │
│  └─────────────────┘                                                     │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 关系说明

| 关系 | 类型 | 说明 |
|------|------|------|
| categories ↔ categories | 1:N | 自引用，支持多级分类 |
| categories ↔ contents | 1:N | 一个分类下有多个内容 |
| contents ↔ artists | N:M | 通过 content_artists 关联 |
| contents ↔ tags | N:M | 通过 content_tags 关联 |
| contents ↔ play_history | 1:N | 一个内容有多条播放记录 |
| categories ↔ english_words | 1:N | 单词按分类组织 |

---

## 4. 表结构设计

### 4.1 分类表 (categories)

```sql
-- 分类表：支持层级分类
CREATE TABLE IF NOT EXISTS categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    parent_id INT DEFAULT NULL COMMENT '父分类ID，NULL表示顶级分类',
    name VARCHAR(50) NOT NULL COMMENT '分类名称',
    name_pinyin VARCHAR(100) COMMENT '名称拼音（用于语音搜索）',
    type ENUM('story', 'music', 'english', 'sound') NOT NULL COMMENT '内容类型',
    level INT DEFAULT 1 COMMENT '层级深度：1=一级，2=二级，3=三级',
    path VARCHAR(200) COMMENT '分类路径，如：/1/3/7/ (用于快速查询子分类)',
    sort_order INT DEFAULT 0 COMMENT '排序权重',
    icon VARCHAR(50) COMMENT '分类图标',
    description TEXT COMMENT '分类描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_parent (parent_id),
    INDEX idx_type (type),
    INDEX idx_type_level (type, level),
    INDEX idx_path (path),
    INDEX idx_name_pinyin (name_pinyin),
    FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='分类表';
```

**分类层级示例:**

```
故事 (type=story, level=1, path=/1/)
├── 童话故事 (level=2, path=/1/5/)
│   ├── 格林童话 (level=3, path=/1/5/14/)
│   ├── 安徒生童话 (level=3, path=/1/5/15/)
│   └── 中国童话 (level=3, path=/1/5/16/)
├── 睡前故事 (level=2, path=/1/6/)
├── 成语故事 (level=2, path=/1/7/)
├── 神话故事 (level=2, path=/1/8/)
└── 科普故事 (level=2, path=/1/9/)

音乐 (type=music, level=1, path=/2/)
├── 儿歌 (level=2, path=/2/10/)
│   ├── 中文儿歌 (level=3, path=/2/10/17/)
│   └── 英文儿歌 (level=3, path=/2/10/18/)
├── 摇篮曲 (level=2, path=/2/11/)
├── 古典音乐 (level=2, path=/2/12/)
└── 流行音乐 (level=2, path=/2/13/)

英语 (type=english, level=1, path=/3/)
├── 单词学习 (level=2, path=/3/20/)
│   ├── 动物 (level=3, path=/3/20/30/)
│   ├── 食物 (level=3, path=/3/20/31/)
│   ├── 颜色 (level=3, path=/3/20/32/)
│   └── 数字 (level=3, path=/3/20/33/)
├── 英语儿歌 (level=2, path=/3/21/)
├── 英语故事 (level=2, path=/3/22/)
└── 日常对话 (level=2, path=/3/23/)
```

### 4.2 艺术家表 (artists)

```sql
-- 艺术家表：歌手、作者、讲述者
CREATE TABLE IF NOT EXISTS artists (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '艺术家名称',
    name_pinyin VARCHAR(200) COMMENT '名称拼音（用于语音搜索）',
    aliases VARCHAR(500) COMMENT '别名，用|分隔，如：周杰伦|Jay|杰伦|周董',
    type ENUM('singer', 'author', 'narrator', 'composer', 'band') NOT NULL
        COMMENT '类型：歌手/作者/讲述者/作曲家/乐队',
    avatar_path VARCHAR(500) COMMENT '头像图片MinIO路径',
    description TEXT COMMENT '艺术家简介',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_name (name),
    INDEX idx_name_pinyin (name_pinyin),
    INDEX idx_type (type),
    FULLTEXT INDEX ft_aliases (aliases) -- 全文索引支持别名搜索
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='艺术家表';
```

**艺术家示例:**

| name | name_pinyin | aliases | type |
|------|-------------|---------|------|
| 周杰伦 | zhoujielun | 周杰伦\|Jay\|杰伦\|周董 | singer |
| 王力宏 | wanglihong | 王力宏\|Leehom\|力宏 | singer |
| 凯叔 | kaishu | 凯叔\|凯叔讲故事\|王凯 | narrator |
| 贝瓦 | beiwa | 贝瓦\|贝瓦儿歌 | band |
| 小猪佩奇 | xiaozhupeigi | 小猪佩奇\|Peppa Pig\|佩奇 | narrator |

### 4.3 标签表 (tags)

```sql
-- 标签表：灵活的标签系统
CREATE TABLE IF NOT EXISTS tags (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL COMMENT '标签名称',
    name_pinyin VARCHAR(100) COMMENT '名称拼音（用于语音搜索）',
    type ENUM('age', 'scene', 'mood', 'theme', 'feature') NOT NULL
        COMMENT '标签类型：年龄段/场景/情绪/主题/特色',
    sort_order INT DEFAULT 0 COMMENT '排序权重',
    color VARCHAR(20) COMMENT '标签颜色（用于UI展示）',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE INDEX uk_name (name),
    INDEX idx_type (type),
    INDEX idx_name_pinyin (name_pinyin)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='标签表';
```

**标签分类示例:**

```
年龄段标签 (type=age):
  - 胎教 (taijiao)
  - 0-3岁 (0-3sui)
  - 3-6岁 (3-6sui)
  - 6-12岁 (6-12sui)
  - 少儿 (shaoer)

场景标签 (type=scene):
  - 睡前 (shuiqian)
  - 早教 (zaojiao)
  - 车载 (chezai)
  - 户外 (huwai)

情绪标签 (type=mood):
  - 欢快 (huankuai)
  - 舒缓 (shuhuan)
  - 温馨 (wenxin)
  - 励志 (lizhi)

主题标签 (type=theme):
  - 经典 (jingdian)
  - 国学 (guoxue)
  - 科普 (kepu)
  - 自然 (ziran)
  - 动物 (dongwu)
  - 英语 (yingyu)

特色标签 (type=feature):
  - 热门 (remen)
  - 精选 (jingxuan)
  - 新上架 (xinshangjia)
  - 独家 (dujia)
```

### 4.4 内容表 (contents)

```sql
-- 内容表：音频内容主表
CREATE TABLE IF NOT EXISTS contents (
    id INT AUTO_INCREMENT PRIMARY KEY,
    type ENUM('story', 'music', 'english', 'sound') NOT NULL COMMENT '内容类型',
    category_id INT NOT NULL COMMENT '分类ID',
    title VARCHAR(200) NOT NULL COMMENT '标题',
    title_pinyin VARCHAR(500) COMMENT '标题拼音（用于语音搜索）',
    subtitle VARCHAR(200) COMMENT '副标题',
    description TEXT COMMENT '内容描述',

    -- 存储信息
    minio_path VARCHAR(500) NOT NULL COMMENT 'MinIO存储路径',
    cover_path VARCHAR(500) COMMENT '封面图片MinIO路径',

    -- 媒体信息
    duration INT COMMENT '时长（秒）',
    file_size INT COMMENT '文件大小（字节）',
    format VARCHAR(20) DEFAULT 'mp3' COMMENT '音频格式',
    bitrate INT COMMENT '比特率',

    -- 适用范围
    age_min INT DEFAULT 0 COMMENT '最小适用年龄',
    age_max INT DEFAULT 12 COMMENT '最大适用年龄',

    -- 统计信息
    play_count INT DEFAULT 0 COMMENT '播放次数',
    like_count INT DEFAULT 0 COMMENT '点赞次数',

    -- 状态
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否上架',
    is_vip BOOLEAN DEFAULT FALSE COMMENT '是否VIP内容',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at TIMESTAMP COMMENT '发布时间',

    -- 索引
    INDEX idx_type (type),
    INDEX idx_category (category_id),
    INDEX idx_type_category (type, category_id),
    INDEX idx_title (title),
    INDEX idx_title_pinyin (title_pinyin),
    INDEX idx_play_count (play_count DESC),
    INDEX idx_created_at (created_at DESC),
    INDEX idx_active_type (is_active, type),

    FOREIGN KEY (category_id) REFERENCES categories(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='内容表';
```

### 4.5 内容-艺术家关联表 (content_artists)

```sql
-- 内容-艺术家关联表
CREATE TABLE IF NOT EXISTS content_artists (
    id INT AUTO_INCREMENT PRIMARY KEY,
    content_id INT NOT NULL COMMENT '内容ID',
    artist_id INT NOT NULL COMMENT '艺术家ID',
    role ENUM('singer', 'author', 'narrator', 'composer', 'lyricist') NOT NULL
        COMMENT '角色：歌手/作者/讲述者/作曲/作词',
    is_primary BOOLEAN DEFAULT FALSE COMMENT '是否主要艺术家',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE INDEX uk_content_artist_role (content_id, artist_id, role),
    INDEX idx_content (content_id),
    INDEX idx_artist (artist_id),
    INDEX idx_artist_role (artist_id, role),

    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (artist_id) REFERENCES artists(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='内容-艺术家关联表';
```

### 4.6 内容-标签关联表 (content_tags)

```sql
-- 内容-标签关联表
CREATE TABLE IF NOT EXISTS content_tags (
    id INT AUTO_INCREMENT PRIMARY KEY,
    content_id INT NOT NULL COMMENT '内容ID',
    tag_id INT NOT NULL COMMENT '标签ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE INDEX uk_content_tag (content_id, tag_id),
    INDEX idx_content (content_id),
    INDEX idx_tag (tag_id),

    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='内容-标签关联表';
```

### 4.7 英语单词表 (english_words)

```sql
-- 英语单词表
CREATE TABLE IF NOT EXISTS english_words (
    id INT AUTO_INCREMENT PRIMARY KEY,
    word VARCHAR(100) NOT NULL COMMENT '单词',
    phonetic_us VARCHAR(100) COMMENT '美式音标',
    phonetic_uk VARCHAR(100) COMMENT '英式音标',
    translation VARCHAR(500) NOT NULL COMMENT '中文释义',

    -- 音频
    audio_us_path VARCHAR(500) COMMENT '美式发音音频MinIO路径',
    audio_uk_path VARCHAR(500) COMMENT '英式发音音频MinIO路径',

    -- 分类
    category_id INT COMMENT '分类ID（如：动物、食物、颜色）',
    level ENUM('basic', 'intermediate', 'advanced') DEFAULT 'basic' COMMENT '难度级别',

    -- 例句
    example_sentence TEXT COMMENT '例句',
    example_translation TEXT COMMENT '例句翻译',
    example_audio_path VARCHAR(500) COMMENT '例句音频MinIO路径',

    -- 扩展
    synonyms VARCHAR(500) COMMENT '同义词',
    antonyms VARCHAR(500) COMMENT '反义词',
    word_forms JSON COMMENT '词形变化',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE INDEX uk_word (word),
    INDEX idx_category (category_id),
    INDEX idx_level (level),
    INDEX idx_category_level (category_id, level),

    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='英语单词表';
```

### 4.8 播放历史表 (play_history)

```sql
-- 播放历史表
CREATE TABLE IF NOT EXISTS play_history (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(100) NOT NULL COMMENT '设备ID',
    content_id INT NOT NULL COMMENT '内容ID',
    content_type ENUM('story', 'music', 'english', 'sound') NOT NULL COMMENT '内容类型',
    played_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '播放时间',
    duration_played INT DEFAULT 0 COMMENT '已播放时长（秒）',
    play_position INT DEFAULT 0 COMMENT '播放位置（秒）',
    completed BOOLEAN DEFAULT FALSE COMMENT '是否播放完成',
    play_source VARCHAR(50) COMMENT '播放来源（search/recommend/history/command）',

    INDEX idx_device_time (device_id, played_at DESC),
    INDEX idx_content (content_id),
    INDEX idx_device_content (device_id, content_id),
    INDEX idx_played_at (played_at),

    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='播放历史表';
```

### 4.9 设备会话表 (device_sessions)

```sql
-- 设备会话表
CREATE TABLE IF NOT EXISTS device_sessions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(100) NOT NULL COMMENT '设备唯一标识',
    device_model VARCHAR(50) COMMENT '设备型号（LX06/OH2P）',
    device_sn VARCHAR(100) COMMENT '设备序列号',
    device_name VARCHAR(100) COMMENT '设备名称',

    -- 连接状态
    is_connected BOOLEAN DEFAULT FALSE COMMENT '是否在线',
    last_connected_at TIMESTAMP COMMENT '最后连接时间',
    last_disconnected_at TIMESTAMP COMMENT '最后断开时间',

    -- 播放状态
    current_content_id INT COMMENT '当前播放内容ID',
    playing_state ENUM('idle', 'playing', 'paused', 'loading') DEFAULT 'idle'
        COMMENT '播放状态',
    play_position INT DEFAULT 0 COMMENT '当前播放位置（秒）',
    volume INT DEFAULT 50 COMMENT '音量（0-100）',

    -- 会话数据
    session_data JSON COMMENT '会话上下文数据',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE INDEX uk_device_id (device_id),
    INDEX idx_connected (is_connected),

    FOREIGN KEY (current_content_id) REFERENCES contents(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='设备会话表';
```

---

## 5. 索引设计

### 5.1 索引策略

| 场景 | 索引类型 | 索引名 | 说明 |
|------|----------|--------|------|
| 按类型查询 | 单列索引 | idx_type | contents.type |
| 按分类查询 | 单列索引 | idx_category | contents.category_id |
| 按艺术家查询 | 关联表索引 | idx_artist | content_artists.artist_id |
| 按标签查询 | 关联表索引 | idx_tag | content_tags.tag_id |
| 拼音搜索 | 前缀索引 | idx_name_pinyin | 支持 LIKE 'pinyin%' |
| 别名搜索 | 全文索引 | ft_aliases | 支持 MATCH AGAINST |
| 热门排序 | 降序索引 | idx_play_count | 按播放量排序 |
| 分类路径 | 前缀索引 | idx_path | 支持 LIKE '/1/5/%' |

### 5.2 复合索引优化

```sql
-- 内容查询常用复合索引
CREATE INDEX idx_active_type_category ON contents(is_active, type, category_id);
CREATE INDEX idx_active_type_playcount ON contents(is_active, type, play_count DESC);

-- 艺术家查询复合索引
CREATE INDEX idx_artist_primary ON content_artists(artist_id, is_primary, content_id);

-- 标签组合查询索引
CREATE INDEX idx_tag_content ON content_tags(tag_id, content_id);
```

---

## 6. 查询场景设计

### 6.1 按艺术家查询

**用户指令**: "想听王力宏的歌"

```sql
-- 查询王力宏的所有歌曲
SELECT c.*
FROM contents c
JOIN content_artists ca ON c.id = ca.content_id
JOIN artists a ON ca.artist_id = a.id
WHERE (
    a.name = '王力宏'
    OR a.name_pinyin LIKE 'wanglihong%'
    OR a.aliases LIKE '%王力宏%'
)
AND c.type = 'music'
AND c.is_active = TRUE
ORDER BY ca.is_primary DESC, c.play_count DESC
LIMIT 20;
```

### 6.2 按标签组合查询

**用户指令**: "播放胎教故事"

```sql
-- 查询带有"胎教"标签的故事
SELECT c.*
FROM contents c
JOIN content_tags ct ON c.id = ct.content_id
JOIN tags t ON ct.tag_id = t.id
WHERE (t.name = '胎教' OR t.name_pinyin = 'taijiao')
  AND c.type = 'story'
  AND c.is_active = TRUE
ORDER BY c.play_count DESC
LIMIT 20;
```

**用户指令**: "播放少儿英语故事"

```sql
-- 查询同时带有"少儿"标签且分类为英语故事
SELECT c.*, COUNT(DISTINCT ct.tag_id) as tag_match_count
FROM contents c
JOIN content_tags ct ON c.id = ct.content_id
JOIN tags t ON ct.tag_id = t.id
JOIN categories cat ON c.category_id = cat.id
WHERE t.name IN ('少儿', '英语')
  AND c.type = 'story'
  AND c.is_active = TRUE
GROUP BY c.id
HAVING tag_match_count >= 1  -- 至少匹配一个标签
ORDER BY tag_match_count DESC, c.play_count DESC
LIMIT 20;

-- 或者通过分类路径查询英语故事
SELECT c.*
FROM contents c
JOIN categories cat ON c.category_id = cat.id
JOIN content_tags ct ON c.id = ct.content_id
JOIN tags t ON ct.tag_id = t.id
WHERE cat.path LIKE '/3/22/%'  -- 英语故事分类路径
  AND t.name = '少儿'
  AND c.is_active = TRUE
ORDER BY c.play_count DESC
LIMIT 20;
```

### 6.3 按分类层级查询

**用户指令**: "播放童话故事"

```sql
-- 方式1: 直接查询分类名
SELECT c.*
FROM contents c
JOIN categories cat ON c.category_id = cat.id
WHERE (cat.name = '童话故事' OR cat.name_pinyin LIKE 'tonghua%')
  AND c.is_active = TRUE
ORDER BY c.play_count DESC
LIMIT 20;

-- 方式2: 查询分类及其所有子分类（利用path字段）
-- 先获取童话故事分类的path
SELECT c.*
FROM contents c
JOIN categories cat ON c.category_id = cat.id
WHERE cat.path LIKE (
    SELECT CONCAT(path, '%')
    FROM categories
    WHERE name = '童话故事'
    LIMIT 1
)
AND c.is_active = TRUE
ORDER BY c.play_count DESC
LIMIT 20;
```

### 6.4 按艺术家+标题查询

**用户指令**: "播放周杰伦的晴天"

```sql
SELECT c.*
FROM contents c
JOIN content_artists ca ON c.id = ca.content_id
JOIN artists a ON ca.artist_id = a.id
WHERE (a.name = '周杰伦' OR a.name_pinyin LIKE 'zhoujielun%')
  AND (c.title LIKE '%晴天%' OR c.title_pinyin LIKE '%qingtian%')
  AND c.is_active = TRUE
ORDER BY
    CASE WHEN c.title = '晴天' THEN 1 ELSE 2 END,
    ca.is_primary DESC
LIMIT 1;
```

### 6.5 综合智能搜索

```sql
-- 综合搜索：标题、艺术家、分类、标签
SELECT DISTINCT c.*,
    -- 标题匹配得分
    CASE
        WHEN c.title = ? THEN 100
        WHEN c.title LIKE CONCAT(?, '%') THEN 80
        WHEN c.title LIKE CONCAT('%', ?, '%') THEN 60
        ELSE 0
    END as title_score,
    -- 艺术家匹配得分
    CASE
        WHEN a.name = ? THEN 50
        WHEN a.name LIKE CONCAT('%', ?, '%') THEN 30
        ELSE 0
    END as artist_score,
    -- 分类匹配得分
    CASE
        WHEN cat.name = ? THEN 40
        WHEN cat.name LIKE CONCAT('%', ?, '%') THEN 20
        ELSE 0
    END as category_score
FROM contents c
LEFT JOIN content_artists ca ON c.id = ca.content_id
LEFT JOIN artists a ON ca.artist_id = a.id
LEFT JOIN categories cat ON c.category_id = cat.id
LEFT JOIN content_tags ct ON c.id = ct.content_id
LEFT JOIN tags t ON ct.tag_id = t.id
WHERE c.is_active = TRUE
  AND (
    c.title LIKE CONCAT('%', ?, '%')
    OR c.title_pinyin LIKE CONCAT('%', ?, '%')
    OR a.name LIKE CONCAT('%', ?, '%')
    OR a.name_pinyin LIKE CONCAT('%', ?, '%')
    OR cat.name LIKE CONCAT('%', ?, '%')
    OR t.name LIKE CONCAT('%', ?, '%')
  )
ORDER BY (title_score + artist_score + category_score) DESC, c.play_count DESC
LIMIT 10;
```

### 6.6 Python 查询服务封装

```python
# app/services/content_service.py

from sqlalchemy import select, func, or_, and_
from sqlalchemy.orm import joinedload
from typing import Optional, List

class ContentService:
    """内容查询服务"""

    def __init__(self, session):
        self.session = session

    async def search_by_artist(
        self,
        artist_name: str,
        content_type: Optional[str] = None,
        limit: int = 20
    ) -> List[Content]:
        """
        按艺术家查询

        Args:
            artist_name: 艺术家名称（支持拼音）
            content_type: 内容类型 (story/music/english/sound)
            limit: 返回数量

        Example:
            # 想听王力宏的歌
            results = await service.search_by_artist("王力宏", "music")
            # 支持拼音
            results = await service.search_by_artist("wanglihong", "music")
        """
        query = (
            select(Content)
            .join(ContentArtist)
            .join(Artist)
            .where(
                or_(
                    Artist.name == artist_name,
                    Artist.name_pinyin.like(f"{artist_name}%"),
                    Artist.aliases.contains(artist_name)
                )
            )
            .where(Content.is_active == True)
        )

        if content_type:
            query = query.where(Content.type == content_type)

        query = (
            query
            .order_by(ContentArtist.is_primary.desc(), Content.play_count.desc())
            .limit(limit)
        )

        result = await self.session.execute(query)
        return result.scalars().all()

    async def search_by_tags(
        self,
        tag_names: List[str],
        content_type: Optional[str] = None,
        match_all: bool = False,
        limit: int = 20
    ) -> List[Content]:
        """
        按标签组合查询

        Args:
            tag_names: 标签名列表
            content_type: 内容类型
            match_all: True=必须匹配所有标签，False=匹配任一标签
            limit: 返回数量

        Example:
            # 播放胎教故事
            results = await service.search_by_tags(["胎教"], "story")
            # 播放少儿英语
            results = await service.search_by_tags(["少儿", "英语"], "story")
        """
        query = (
            select(Content, func.count(ContentTag.tag_id).label('match_count'))
            .join(ContentTag)
            .join(Tag)
            .where(
                or_(
                    Tag.name.in_(tag_names),
                    Tag.name_pinyin.in_(tag_names)
                )
            )
            .where(Content.is_active == True)
        )

        if content_type:
            query = query.where(Content.type == content_type)

        query = query.group_by(Content.id)

        if match_all:
            # 必须匹配所有标签
            query = query.having(func.count(ContentTag.tag_id) >= len(tag_names))

        query = (
            query
            .order_by(func.count(ContentTag.tag_id).desc(), Content.play_count.desc())
            .limit(limit)
        )

        result = await self.session.execute(query)
        return [row[0] for row in result.all()]

    async def search_by_category(
        self,
        category_name: str,
        include_children: bool = True,
        limit: int = 20
    ) -> List[Content]:
        """
        按分类查询

        Args:
            category_name: 分类名称（支持拼音）
            include_children: 是否包含子分类
            limit: 返回数量

        Example:
            # 播放童话故事（包含格林童话、安徒生童话等子分类）
            results = await service.search_by_category("童话故事", include_children=True)
        """
        # 先查找分类
        cat_query = select(Category).where(
            or_(
                Category.name == category_name,
                Category.name_pinyin.like(f"{category_name}%")
            )
        )
        cat_result = await self.session.execute(cat_query)
        category = cat_result.scalar_one_or_none()

        if not category:
            return []

        # 查询内容
        query = select(Content).where(Content.is_active == True)

        if include_children and category.path:
            # 包含子分类：使用path前缀匹配
            query = query.join(Category).where(
                Category.path.like(f"{category.path}%")
            )
        else:
            query = query.where(Content.category_id == category.id)

        query = query.order_by(Content.play_count.desc()).limit(limit)

        result = await self.session.execute(query)
        return result.scalars().all()

    async def search_by_artist_and_title(
        self,
        artist_name: str,
        title_keyword: str
    ) -> Optional[Content]:
        """
        按艺术家+标题精确查询

        Args:
            artist_name: 艺术家名称
            title_keyword: 标题关键词

        Example:
            # 播放周杰伦的晴天
            result = await service.search_by_artist_and_title("周杰伦", "晴天")
        """
        query = (
            select(Content)
            .join(ContentArtist)
            .join(Artist)
            .where(
                or_(
                    Artist.name == artist_name,
                    Artist.name_pinyin.like(f"{artist_name}%")
                )
            )
            .where(
                or_(
                    Content.title.like(f"%{title_keyword}%"),
                    Content.title_pinyin.like(f"%{title_keyword}%")
                )
            )
            .where(Content.is_active == True)
            .order_by(
                # 完全匹配优先
                func.length(Content.title),
                ContentArtist.is_primary.desc()
            )
            .limit(1)
        )

        result = await self.session.execute(query)
        return result.scalar_one_or_none()

    async def smart_search(
        self,
        keyword: str,
        content_type: Optional[str] = None,
        limit: int = 10
    ) -> List[Content]:
        """
        智能综合搜索

        Args:
            keyword: 搜索关键词
            content_type: 内容类型（可选）
            limit: 返回数量

        Example:
            # 任意关键词搜索
            results = await service.smart_search("睡前故事")
            results = await service.smart_search("周杰伦")
        """
        # 使用子查询获取匹配的内容ID和得分
        query = (
            select(Content)
            .outerjoin(ContentArtist)
            .outerjoin(Artist)
            .outerjoin(Category)
            .outerjoin(ContentTag)
            .outerjoin(Tag)
            .where(Content.is_active == True)
            .where(
                or_(
                    Content.title.like(f"%{keyword}%"),
                    Content.title_pinyin.like(f"%{keyword}%"),
                    Artist.name.like(f"%{keyword}%"),
                    Artist.name_pinyin.like(f"%{keyword}%"),
                    Category.name.like(f"%{keyword}%"),
                    Category.name_pinyin.like(f"%{keyword}%"),
                    Tag.name.like(f"%{keyword}%"),
                    Tag.name_pinyin.like(f"%{keyword}%")
                )
            )
            .distinct()
        )

        if content_type:
            query = query.where(Content.type == content_type)

        query = query.order_by(Content.play_count.desc()).limit(limit)

        result = await self.session.execute(query)
        return result.scalars().all()
```

---

## 7. MinIO 存储设计

### 7.1 Bucket 结构

```
voicegrow-bucket/
├── stories/                    # 故事音频
│   ├── fairy_tale/            # 童话故事
│   │   ├── grimm/             # 格林童话
│   │   └── andersen/          # 安徒生童话
│   ├── bedtime/               # 睡前故事
│   ├── science/               # 科普故事
│   └── idiom/                 # 成语故事
│
├── music/                      # 音乐文件
│   ├── nursery_rhyme/         # 儿歌
│   │   ├── chinese/           # 中文儿歌
│   │   └── english/           # 英文儿歌
│   ├── lullaby/               # 摇篮曲
│   ├── classical/             # 古典音乐
│   └── pop/                   # 流行音乐
│
├── english/                    # 英语学习
│   ├── words/                 # 单词发音
│   │   ├── us/                # 美式发音
│   │   └── uk/                # 英式发音
│   ├── sentences/             # 例句发音
│   └── songs/                 # 英语儿歌
│
├── covers/                     # 封面图片
│   ├── contents/              # 内容封面
│   └── artists/               # 艺术家头像
│
├── tts_cache/                  # TTS缓存（临时）
│   └── {date}/                # 按日期分目录
│
└── temp/                       # 临时文件
```

### 7.2 文件命名规范

```
# 内容音频
{type}/{category_path}/{content_id}_{title_pinyin}.{format}
例: stories/fairy_tale/grimm/001_xiaohongmao.mp3

# 单词发音
english/words/{us|uk}/{word}.mp3
例: english/words/us/apple.mp3

# 封面图片
covers/contents/{content_id}.{jpg|png}
例: covers/contents/001.jpg

# 艺术家头像
covers/artists/{artist_id}.{jpg|png}
例: covers/artists/001.jpg

# TTS缓存
tts_cache/{date}/{text_hash}.mp3
例: tts_cache/20250120/a1b2c3d4.mp3
```

---

## 8. Redis 缓存设计

### 8.1 Key 命名规范

```
# 格式: {业务}:{对象类型}:{标识}:{字段}

# 内容缓存
content:{content_id}                    # 单个内容详情 (Hash)
content:list:{type}:{category_id}       # 分类下内容列表 (List)
content:hot:{type}                      # 热门内容列表 (ZSet)

# 分类缓存
category:tree:{type}                    # 分类树 (String/JSON)
category:{category_id}                  # 单个分类 (Hash)

# 艺术家缓存
artist:{artist_id}                      # 艺术家详情 (Hash)
artist:search:{keyword}                 # 艺术家搜索结果 (List)
artist:contents:{artist_id}             # 艺术家作品列表 (List)

# 标签缓存
tag:list:{type}                         # 标签列表 (List)
tag:contents:{tag_id}                   # 标签关联内容 (List)

# 设备会话
device:{device_id}:session              # 设备会话数据 (Hash)
device:{device_id}:history              # 最近播放历史 (List)

# ASR/TTS缓存
asr:{audio_hash}                        # ASR识别结果 (String)
tts:{text_hash}                         # TTS音频路径 (String)

# 搜索缓存
search:{keyword_hash}:{type}            # 搜索结果缓存 (List)
```

### 8.2 TTL 策略

| Key类型 | TTL | 说明 |
|---------|-----|------|
| content:{id} | 1小时 | 内容详情 |
| content:list:* | 10分钟 | 内容列表 |
| content:hot:* | 5分钟 | 热门列表（频繁变化）|
| category:tree:* | 24小时 | 分类树（变化少）|
| artist:* | 1小时 | 艺术家信息 |
| tag:list:* | 24小时 | 标签列表 |
| device:*:session | 不过期 | 设备会话 |
| device:*:history | 7天 | 播放历史 |
| asr:* | 24小时 | ASR缓存 |
| tts:* | 7天 | TTS缓存 |
| search:* | 30分钟 | 搜索结果 |

### 8.3 缓存更新策略

```python
# 内容更新时清除相关缓存
async def invalidate_content_cache(content_id: int, content: Content):
    keys_to_delete = [
        f"content:{content_id}",
        f"content:list:{content.type}:{content.category_id}",
        f"content:hot:{content.type}",
    ]

    # 清除艺术家相关缓存
    for artist in content.artists:
        keys_to_delete.append(f"artist:contents:{artist.id}")

    # 清除标签相关缓存
    for tag in content.tags:
        keys_to_delete.append(f"tag:contents:{tag.id}")

    await redis.delete(*keys_to_delete)
```

---

## 9. 数据维护

### 9.1 初始化数据脚本

```sql
-- ============================================
-- VoiceGrow 数据库初始化脚本
-- ============================================

-- 创建数据库
CREATE DATABASE IF NOT EXISTS voicegrow
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

USE voicegrow;

-- ============================================
-- 插入顶级分类
-- ============================================
INSERT INTO categories (id, name, name_pinyin, type, level, path, sort_order) VALUES
(1, '故事', 'gushi', 'story', 1, '/1/', 1),
(2, '音乐', 'yinyue', 'music', 1, '/2/', 2),
(3, '英语', 'yingyu', 'english', 1, '/3/', 3),
(4, '声音', 'shengyin', 'sound', 1, '/4/', 4);

-- ============================================
-- 插入二级分类（故事）
-- ============================================
INSERT INTO categories (id, parent_id, name, name_pinyin, type, level, path, sort_order) VALUES
(5, 1, '童话故事', 'tonghuagushi', 'story', 2, '/1/5/', 1),
(6, 1, '睡前故事', 'shuiqiangushi', 'story', 2, '/1/6/', 2),
(7, 1, '成语故事', 'chengyugushi', 'story', 2, '/1/7/', 3),
(8, 1, '神话故事', 'shenhuagushi', 'story', 2, '/1/8/', 4),
(9, 1, '科普故事', 'kepugushi', 'story', 2, '/1/9/', 5);

-- ============================================
-- 插入三级分类（童话故事）
-- ============================================
INSERT INTO categories (id, parent_id, name, name_pinyin, type, level, path, sort_order) VALUES
(14, 5, '格林童话', 'gelintonghua', 'story', 3, '/1/5/14/', 1),
(15, 5, '安徒生童话', 'antushengtonghua', 'story', 3, '/1/5/15/', 2),
(16, 5, '中国童话', 'zhongguotonghua', 'story', 3, '/1/5/16/', 3);

-- ============================================
-- 插入二级分类（音乐）
-- ============================================
INSERT INTO categories (id, parent_id, name, name_pinyin, type, level, path, sort_order) VALUES
(10, 2, '儿歌', 'erge', 'music', 2, '/2/10/', 1),
(11, 2, '摇篮曲', 'yaolanqu', 'music', 2, '/2/11/', 2),
(12, 2, '古典音乐', 'gudianyinyue', 'music', 2, '/2/12/', 3),
(13, 2, '流行音乐', 'liuxingyinyue', 'music', 2, '/2/13/', 4);

-- ============================================
-- 插入三级分类（儿歌）
-- ============================================
INSERT INTO categories (id, parent_id, name, name_pinyin, type, level, path, sort_order) VALUES
(17, 10, '中文儿歌', 'zhongwenerge', 'music', 3, '/2/10/17/', 1),
(18, 10, '英文儿歌', 'yingwenerge', 'music', 3, '/2/10/18/', 2);

-- ============================================
-- 插入二级分类（英语）
-- ============================================
INSERT INTO categories (id, parent_id, name, name_pinyin, type, level, path, sort_order) VALUES
(20, 3, '单词学习', 'dancixuexi', 'english', 2, '/3/20/', 1),
(21, 3, '英语儿歌', 'yingyuerge', 'english', 2, '/3/21/', 2),
(22, 3, '英语故事', 'yingyugushi', 'english', 2, '/3/22/', 3),
(23, 3, '日常对话', 'richangduihua', 'english', 2, '/3/23/', 4);

-- ============================================
-- 插入三级分类（单词学习）
-- ============================================
INSERT INTO categories (id, parent_id, name, name_pinyin, type, level, path, sort_order) VALUES
(30, 20, '动物', 'dongwu', 'english', 3, '/3/20/30/', 1),
(31, 20, '食物', 'shiwu', 'english', 3, '/3/20/31/', 2),
(32, 20, '颜色', 'yanse', 'english', 3, '/3/20/32/', 3),
(33, 20, '数字', 'shuzi', 'english', 3, '/3/20/33/', 4),
(34, 20, '身体部位', 'shentibuwei', 'english', 3, '/3/20/34/', 5),
(35, 20, '家庭成员', 'jiatingchengyuan', 'english', 3, '/3/20/35/', 6);

-- ============================================
-- 插入标签
-- ============================================
INSERT INTO tags (name, name_pinyin, type, sort_order) VALUES
-- 年龄段标签
('胎教', 'taijiao', 'age', 1),
('0-3岁', '0-3sui', 'age', 2),
('3-6岁', '3-6sui', 'age', 3),
('6-12岁', '6-12sui', 'age', 4),
('少儿', 'shaoer', 'age', 5),
-- 场景标签
('睡前', 'shuiqian', 'scene', 10),
('早教', 'zaojiao', 'scene', 11),
('车载', 'chezai', 'scene', 12),
('户外', 'huwai', 'scene', 13),
-- 主题标签
('经典', 'jingdian', 'theme', 20),
('国学', 'guoxue', 'theme', 21),
('科普', 'kepu', 'theme', 22),
('英语', 'yingyu', 'theme', 23),
('自然', 'ziran', 'theme', 24),
('动物', 'dongwu', 'theme', 25),
-- 情绪标签
('欢快', 'huankuai', 'mood', 30),
('舒缓', 'shuhuan', 'mood', 31),
('温馨', 'wenxin', 'mood', 32),
('励志', 'lizhi', 'mood', 33),
-- 特色标签
('热门', 'remen', 'feature', 40),
('精选', 'jingxuan', 'feature', 41),
('新上架', 'xinshangjia', 'feature', 42);

-- ============================================
-- 插入示例艺术家
-- ============================================
INSERT INTO artists (name, name_pinyin, aliases, type) VALUES
('周杰伦', 'zhoujielun', '周杰伦|Jay|杰伦|周董|Jay Chou', 'singer'),
('王力宏', 'wanglihong', '王力宏|Leehom|力宏|Wang Leehom', 'singer'),
('林俊杰', 'linjunjie', '林俊杰|JJ|JJ Lin', 'singer'),
('凯叔', 'kaishu', '凯叔|凯叔讲故事|王凯', 'narrator'),
('贝瓦', 'beiwa', '贝瓦|贝瓦儿歌|Beva', 'band'),
('小猪佩奇', 'xiaozhupeigi', '小猪佩奇|Peppa Pig|佩奇|粉红猪小妹', 'narrator'),
('巧虎', 'qiaohu', '巧虎|Qiaohu|巧連智', 'narrator'),
('喜马拉雅', 'ximalaya', '喜马拉雅|Himalaya', 'narrator');

-- ============================================
-- 插入示例内容
-- ============================================
INSERT INTO contents (type, category_id, title, title_pinyin, minio_path, duration, description) VALUES
('story', 14, '小红帽', 'xiaohongmao', 'stories/fairy_tale/grimm/xiaohongmao.mp3', 300, '经典格林童话，讲述小红帽和大灰狼的故事'),
('story', 14, '白雪公主', 'baixuegongzhu', 'stories/fairy_tale/grimm/baixuegongzhu.mp3', 420, '格林童话经典，白雪公主和七个小矮人的故事'),
('story', 15, '丑小鸭', 'chouxiaoya', 'stories/fairy_tale/andersen/chouxiaoya.mp3', 360, '安徒生童话，丑小鸭变天鹅的励志故事'),
('story', 6, '晚安小熊', 'wananxiaoxiong', 'stories/bedtime/wananxiaoxiong.mp3', 180, '温馨的睡前故事'),
('music', 17, '小星星', 'xiaoxingxing', 'music/nursery_rhyme/chinese/xiaoxingxing.mp3', 120, '经典儿歌 Twinkle Twinkle Little Star'),
('music', 17, '两只老虎', 'liangzhilaohu', 'music/nursery_rhyme/chinese/liangzhilaohu.mp3', 90, '经典中文儿歌'),
('music', 13, '晴天', 'qingtian', 'music/pop/zhoujielun/qingtian.mp3', 269, '周杰伦经典歌曲'),
('music', 13, '稻香', 'daoxiang', 'music/pop/zhoujielun/daoxiang.mp3', 234, '周杰伦励志歌曲');

-- ============================================
-- 关联内容和艺术家
-- ============================================
INSERT INTO content_artists (content_id, artist_id, role, is_primary) VALUES
(7, 1, 'singer', TRUE),  -- 晴天 - 周杰伦
(8, 1, 'singer', TRUE);  -- 稻香 - 周杰伦

-- ============================================
-- 关联内容和标签
-- ============================================
INSERT INTO content_tags (content_id, tag_id)
SELECT c.id, t.id FROM contents c, tags t
WHERE c.title = '小红帽' AND t.name IN ('3-6岁', '经典');

INSERT INTO content_tags (content_id, tag_id)
SELECT c.id, t.id FROM contents c, tags t
WHERE c.title = '白雪公主' AND t.name IN ('3-6岁', '经典');

INSERT INTO content_tags (content_id, tag_id)
SELECT c.id, t.id FROM contents c, tags t
WHERE c.title = '丑小鸭' AND t.name IN ('3-6岁', '励志', '经典');

INSERT INTO content_tags (content_id, tag_id)
SELECT c.id, t.id FROM contents c, tags t
WHERE c.title = '晚安小熊' AND t.name IN ('0-3岁', '睡前', '温馨');

INSERT INTO content_tags (content_id, tag_id)
SELECT c.id, t.id FROM contents c, tags t
WHERE c.title = '小星星' AND t.name IN ('0-3岁', '经典');

INSERT INTO content_tags (content_id, tag_id)
SELECT c.id, t.id FROM contents c, tags t
WHERE c.title = '两只老虎' AND t.name IN ('0-3岁', '经典', '欢快');

INSERT INTO content_tags (content_id, tag_id)
SELECT c.id, t.id FROM contents c, tags t
WHERE c.title = '晴天' AND t.name IN ('6-12岁', '热门');

INSERT INTO content_tags (content_id, tag_id)
SELECT c.id, t.id FROM contents c, tags t
WHERE c.title = '稻香' AND t.name IN ('6-12岁', '励志', '热门');

-- ============================================
-- 插入示例英语单词
-- ============================================
INSERT INTO english_words (word, phonetic_us, phonetic_uk, translation, category_id, level, example_sentence, example_translation) VALUES
('dog', '/dɑːɡ/', '/dɒɡ/', '狗', 30, 'basic', 'The dog is running.', '狗在跑。'),
('cat', '/kæt/', '/kæt/', '猫', 30, 'basic', 'The cat is sleeping.', '猫在睡觉。'),
('bird', '/bɜːrd/', '/bɜːd/', '鸟', 30, 'basic', 'The bird is singing.', '鸟在唱歌。'),
('apple', '/ˈæpl/', '/ˈæpl/', '苹果', 31, 'basic', 'I like to eat apples.', '我喜欢吃苹果。'),
('banana', '/bəˈnænə/', '/bəˈnɑːnə/', '香蕉', 31, 'basic', 'The banana is yellow.', '香蕉是黄色的。'),
('red', '/red/', '/red/', '红色', 32, 'basic', 'The apple is red.', '苹果是红色的。'),
('blue', '/bluː/', '/bluː/', '蓝色', 32, 'basic', 'The sky is blue.', '天空是蓝色的。'),
('one', '/wʌn/', '/wʌn/', '一', 33, 'basic', 'I have one apple.', '我有一个苹果。'),
('two', '/tuː/', '/tuː/', '二', 33, 'basic', 'I have two eyes.', '我有两只眼睛。'),
('hello', '/həˈloʊ/', '/həˈləʊ/', '你好', NULL, 'basic', 'Hello, how are you?', '你好，你好吗？');
```

### 9.2 数据备份策略

| 数据类型 | 备份频率 | 保留周期 | 备份方式 |
|----------|----------|----------|----------|
| MySQL | 每日 | 30天 | mysqldump + gzip |
| MinIO | 每周 | 90天 | mc mirror |
| Redis | 每日 | 7天 | RDB + AOF |

### 9.3 数据清理策略

```sql
-- 清理过期播放历史（保留90天）
DELETE FROM play_history
WHERE played_at < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- 清理离线设备会话数据（超过30天未连接）
UPDATE device_sessions
SET session_data = NULL
WHERE last_connected_at < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- 优化表
OPTIMIZE TABLE play_history;
OPTIMIZE TABLE device_sessions;
```

---

## 附录

### A. 完整建表脚本

完整的数据库初始化脚本见: `scripts/init_v2.sql`

### B. 拼音生成工具

```python
# 使用 pypinyin 库生成拼音
from pypinyin import lazy_pinyin

def to_pinyin(text: str) -> str:
    """将中文转换为拼音（无声调，连写）"""
    return ''.join(lazy_pinyin(text))

# 示例
print(to_pinyin("童话故事"))  # tonghuagushi
print(to_pinyin("周杰伦"))    # zhoujielun
```

### C. 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0 | 2025-01 | 初始版本 |
| 1.1 | 2025-01 | 重构分类系统为层级表，新增艺术家表和标签表，支持多维度查询 |
