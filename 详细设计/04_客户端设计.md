# VoiceGrow 客户端设计

> 版本: v1.0
> 更新日期: 2026-01-20
> 文档类型: 客户端设计文档

---

## 1. 客户端概述

### 1.1 设计背景

VoiceGrow 项目的客户端基于 [open-xiaoai](https://github.com/idootop/open-xiaoai) 开源项目，这是一个用 Rust 编写的小爱音箱控制客户端。**本项目无需自行开发客户端**，而是直接使用 open-xiaoai 提供的功能。

### 1.2 支持设备

| 设备型号 | 产品名称 | 支持状态 |
|---------|---------|---------|
| LX06 | 小爱音箱 Pro | ✅ 完全支持 |
| OH2P | Xiaomi Smart Speaker Pro | ✅ 完全支持 |

> **注意**: 仅支持以上两款设备，其他小爱音箱型号不受支持。

### 1.3 客户端能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        open-xiaoai 客户端能力                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │    音频采集      │  │    事件上报      │  │    命令执行      │            │
│  │                 │  │                 │  │                 │            │
│  │ • 麦克风录音    │  │ • 唤醒词检测    │  │ • 播放音频URL   │            │
│  │ • 16kHz PCM    │  │ • 播放状态上报  │  │ • TTS播放文字   │            │
│  │ • 实时流传输   │  │ • 指令识别结果  │  │ • 播放控制      │            │
│  │                 │  │                 │  │ • 麦克风控制    │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 客户端架构

### 2.1 open-xiaoai 架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        open-xiaoai 客户端架构                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                         ┌──────────────────┐
                         │   open-xiaoai    │
                         │   Rust Client    │
                         └────────┬─────────┘
                                  │
            ┌─────────────────────┼─────────────────────┐
            │                     │                     │
            ▼                     ▼                     ▼
     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
     │   音频模块    │     │   通信模块    │     │   控制模块    │
     │              │     │              │     │              │
     │ • 麦克风采集 │     │ • WebSocket  │     │ • 播放控制   │
     │ • 音频编码   │     │ • 事件订阅   │     │ • 音量调节   │
     │ • 流传输     │     │ • 命令执行   │     │ • 麦克风开关 │
     └──────────────┘     └──────────────┘     └──────────────┘
            │                     │                     │
            └─────────────────────┼─────────────────────┘
                                  │
                                  ▼
                         ┌──────────────────┐
                         │    小爱音箱      │
                         │   (LX06/OH2P)   │
                         └──────────────────┘
```

### 2.2 与服务端交互

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          客户端-服务端交互流程                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  小爱音箱                   open-xiaoai                    VoiceGrow Server
     │                          │                                │
     │    麦克风输入            │                                │
     │ ─────────────────────────▶                                │
     │                          │                                │
     │                          │   WebSocket 连接               │
     │                          │ ──────────────────────────────▶│
     │                          │                                │
     │    检测到唤醒词          │                                │
     │ ─────────────────────────▶   Event: kws                   │
     │                          │ ──────────────────────────────▶│
     │                          │                                │
     │    音频流传输            │                                │
     │ ─────────────────────────▶   Stream: record (binary)      │
     │                          │ ──────────────────────────────▶│
     │                          │                                │
     │                          │                  ASR → NLU → Handler
     │                          │                                │
     │                          │   Request: play_url            │
     │                          │ ◀──────────────────────────────│
     │    播放音频              │                                │
     │ ◀─────────────────────────                                │
     │                          │                                │
     │    播放状态变化          │                                │
     │ ─────────────────────────▶   Event: playing               │
     │                          │ ──────────────────────────────▶│
     │                          │                                │
```

---

## 3. 通信协议

### 3.1 WebSocket 连接

```yaml
# 连接配置
endpoint: ws://<server_ip>:4399
protocol: WebSocket
message_format:
  - text: JSON (Event/Request/Response)
  - binary: Audio Stream (PCM)
```

### 3.2 消息类型

#### 3.2.1 Event (客户端 → 服务端)

客户端主动上报的事件。

```json
// 唤醒词事件
{
    "id": "uuid-xxx",
    "event": "kws",
    "data": "小爱同学"
}

// 播放状态事件
{
    "id": "uuid-xxx",
    "event": "playing",
    "data": "Playing"  // Playing | Paused | Idle
}

// 客户端 ASR 结果 (参考用)
{
    "id": "uuid-xxx",
    "event": "instruction",
    "data": {
        "namespace": "SpeechRecognizer",
        "name": "RecognizeResult",
        "payload": {
            "results": [{"text": "讲个故事"}]
        }
    }
}
```

#### 3.2.2 Stream (客户端 → 服务端)

音频流数据，以二进制格式传输。

```yaml
音频格式:
  format: PCM
  sample_rate: 16000   # 16kHz
  sample_width: 2       # 16-bit
  channels: 1           # 单声道

传输方式: WebSocket Binary Message
标签: "record"
```

#### 3.2.3 Request (服务端 → 客户端)

服务端发送的命令请求。

```json
// 播放音频 URL
{
    "id": "uuid-xxx",
    "command": "play_url",
    "payload": {
        "url": "https://minio.example.com/audio.mp3",
        "block": false
    }
}

// 播放文字 (设备 TTS)
{
    "id": "uuid-xxx",
    "command": "play_text",
    "payload": {
        "text": "好的，现在为你播放小红帽",
        "block": false
    }
}

// 暂停播放
{
    "id": "uuid-xxx",
    "command": "pause"
}

// 继续播放
{
    "id": "uuid-xxx",
    "command": "play"
}
```

#### 3.2.4 Response (客户端 → 服务端)

客户端对命令的响应。

```json
// 成功响应
{
    "id": "uuid-xxx",
    "code": 0,
    "msg": "success",
    "data": null
}

// 失败响应
{
    "id": "uuid-xxx",
    "code": -1,
    "msg": "Command failed",
    "data": null
}
```

### 3.3 命令列表

| 命令 | payload | 说明 |
|-----|---------|------|
| `play_url` | `{url, block?}` | 播放音频 URL |
| `play_text` | `{text, block?}` | 设备 TTS 播放 |
| `play` | - | 继续播放 |
| `pause` | - | 暂停播放 |
| `get_play_status` | - | 获取播放状态 |
| `mic_on` | - | 开启麦克风 |
| `mic_off` | - | 关闭麦克风 |
| `wake_up` | `{silent?}` | 唤醒设备 |
| `abort_xiaoai` | - | 中断原生小爱 |
| `ask_xiaoai` | `{text}` | 发送文字给原生小爱 |
| `get_device_model` | - | 获取设备型号 |
| `get_device_sn` | - | 获取序列号 |
| `run_shell` | `{script, timeout?}` | 执行 shell 脚本 |

---

## 4. 客户端配置

### 4.1 open-xiaoai 配置

```yaml
# open-xiaoai 配置文件示例
server:
  # VoiceGrow 服务端地址
  url: "ws://192.168.1.100:4399"

device:
  # 设备型号
  model: "LX06"  # 或 "OH2P"

audio:
  # 音频采集配置
  sample_rate: 16000
  channels: 1
  bits_per_sample: 16

wake_word:
  # 唤醒词配置 (MVP 阶段使用默认)
  enabled: true
  keyword: "小爱同学"
```

### 4.2 设备部署

```bash
# 1. 在支持的小爱音箱上安装 open-xiaoai
# (具体步骤参考 open-xiaoai 项目文档)

# 2. 配置服务端地址
# 修改 open-xiaoai 配置，指向 VoiceGrow 服务端

# 3. 启动客户端
./open-xiaoai --config config.yaml
```

---

## 5. 客户端状态机

### 5.1 状态定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            客户端状态机                                       │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │    IDLE     │
                              │   (空闲)    │
                              └──────┬──────┘
                                     │
                         唤醒词检测 (kws)
                                     │
                                     ▼
                              ┌─────────────┐
                              │   WOKEN     │
                              │   (已唤醒)   │
                              └──────┬──────┘
                                     │
                           开始接收音频流
                                     │
                                     ▼
                              ┌─────────────┐
                              │  LISTENING  │
                              │  (监听中)   │
                              └──────┬──────┘
                                     │
                          静音检测 / 超时
                                     │
                                     ▼
                              ┌─────────────┐
                              │ PROCESSING  │
                              │  (处理中)   │
                              └──────┬──────┘
                                     │
                              Handler 处理完成
                                     │
                                     ▼
                              ┌─────────────┐
                              │ RESPONDING  │
                              │  (响应中)   │
                              └──────┬──────┘
                                     │
                              播放完成 / 超时
                                     │
                                     ▼
                              ┌─────────────┐
                              │    IDLE     │
                              │   (空闲)    │
                              └─────────────┘
```

### 5.2 状态转换表

| 当前状态 | 事件/条件 | 目标状态 | 动作 |
|---------|----------|---------|-----|
| IDLE | kws 事件 | WOKEN | 准备录音 |
| WOKEN | 收到音频数据 | LISTENING | 开始缓冲 |
| WOKEN | 超时 (5s) | IDLE | 回到空闲 |
| LISTENING | 静音检测 | PROCESSING | 发送 ASR |
| LISTENING | 超时 (10s) | PROCESSING | 发送 ASR |
| PROCESSING | 处理完成 | RESPONDING | 执行响应 |
| PROCESSING | 处理失败 | RESPONDING | 播放错误提示 |
| RESPONDING | 播放完成 | IDLE | 回到空闲 |

---

## 6. 音频流处理

### 6.1 音频采集流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            音频采集流程                                       │
└─────────────────────────────────────────────────────────────────────────────┘

  小爱音箱麦克风                open-xiaoai                    VoiceGrow Server
        │                           │                                │
        │    原始音频信号           │                                │
        │ ──────────────────────────▶                                │
        │                           │                                │
        │                    ┌──────┴──────┐                         │
        │                    │  音频采集   │                         │
        │                    │  16kHz PCM  │                         │
        │                    └──────┬──────┘                         │
        │                           │                                │
        │                    ┌──────┴──────┐                         │
        │                    │  分帧处理   │                         │
        │                    │ 每帧 20-40ms│                         │
        │                    └──────┬──────┘                         │
        │                           │                                │
        │                           │   WebSocket Binary             │
        │                           │ ──────────────────────────────▶│
        │                           │                                │
        │                           │              ┌─────────────────┴────┐
        │                           │              │     AudioBuffer      │
        │                           │              │   累积音频数据       │
        │                           │              └─────────────────┬────┘
        │                           │                                │
        │                           │              ┌─────────────────┴────┐
        │                           │              │    VAD 检测          │
        │                           │              │  静音 → 停止接收     │
        │                           │              └─────────────────┬────┘
        │                           │                                │
        │                           │              ┌─────────────────┴────┐
        │                           │              │       ASR            │
        │                           │              │    Whisper 识别      │
        │                           │              └──────────────────────┘
```

### 6.2 音频参数

```yaml
采集参数:
  sample_rate: 16000    # 采样率 16kHz
  sample_width: 2       # 采样位深 16-bit
  channels: 1           # 单声道
  frame_size: 320-640   # 每帧采样点数 (20-40ms)

传输参数:
  protocol: WebSocket Binary
  chunk_size: 1024-4096 # 每次发送字节数
  latency: < 50ms       # 传输延迟

缓冲参数:
  max_duration: 10s     # 最大录音时长
  silence_threshold: 0.5s  # 静音判断阈值
  min_duration: 0.3s    # 最小有效时长
```

---

## 7. 播放控制

### 7.1 播放命令

```python
# 服务端发送播放命令示例

# 1. 播放音频 URL (推荐)
await send_request(device_id, "play_url", {
    "url": "https://minio.example.com/stories/story.mp3",
    "block": False  # 不阻塞
})

# 2. 使用设备 TTS (备用)
await send_request(device_id, "play_text", {
    "text": "好的，现在为你播放小红帽",
    "block": False
})

# 3. 暂停
await send_request(device_id, "pause")

# 4. 继续
await send_request(device_id, "play")

# 5. 获取播放状态
status = await send_request(device_id, "get_play_status", wait_response=True)
# status.data = "Playing" | "Paused" | "Idle"
```

### 7.2 播放状态

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            播放状态机                                         │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │    Idle     │
                              │   (空闲)    │
                              └──────┬──────┘
                                     │
                              play_url / play_text
                                     │
                                     ▼
                              ┌─────────────┐
                        ┌─────│   Playing   │─────┐
                        │     │   (播放中)   │     │
                        │     └──────┬──────┘     │
                        │            │            │
                     pause       播放结束      pause
                        │            │            │
                        ▼            ▼            ▼
                 ┌───────────┐ ┌─────────────┐ ┌───────────┐
                 │  Paused   │ │    Idle     │ │  Paused   │
                 │  (暂停)   │ │   (空闲)    │ │  (暂停)   │
                 └─────┬─────┘ └─────────────┘ └─────┬─────┘
                       │                             │
                    play (继续)                   play (继续)
                       │                             │
                       └──────────────┬──────────────┘
                                      │
                                      ▼
                              ┌─────────────┐
                              │   Playing   │
                              │   (播放中)   │
                              └─────────────┘
```

---

## 8. 错误处理

### 8.1 客户端错误

| 错误类型 | 原因 | 处理方式 |
|---------|-----|---------|
| 连接失败 | 服务端不可达 | 自动重连 (指数退避) |
| 连接断开 | 网络中断 | 自动重连 |
| 命令超时 | 服务端响应慢 | 重试或放弃 |
| 播放失败 | URL 无效 | 上报错误事件 |

### 8.2 重连策略

```python
# 重连策略
reconnect_config = {
    "initial_delay": 1,      # 初始延迟 1 秒
    "max_delay": 60,         # 最大延迟 60 秒
    "multiplier": 2,         # 指数退避倍数
    "max_retries": None,     # 无限重试
}

# 重连逻辑
async def reconnect():
    delay = initial_delay
    while True:
        try:
            await connect()
            return
        except Exception:
            await sleep(delay)
            delay = min(delay * multiplier, max_delay)
```

---

## 9. 安全考虑

### 9.1 通信安全

```yaml
当前实现 (MVP):
  - WebSocket 明文传输 (ws://)
  - 内网部署，外部不可访问

后续增强:
  - WebSocket over TLS (wss://)
  - 设备认证机制
  - 通信加密
```

### 9.2 设备认证

```python
# 设备认证方案 (后续实现)

# 1. 设备 ID 认证
websocket_url = f"ws://server:4399?device_id={device_id}&token={auth_token}"

# 2. 服务端验证
@app.websocket("/")
async def websocket_endpoint(websocket: WebSocket):
    device_id = websocket.query_params.get("device_id")
    token = websocket.query_params.get("token")

    if not verify_device_token(device_id, token):
        await websocket.close(code=4001)
        return

    # 继续处理...
```

---

## 10. 性能要求

### 10.1 性能指标

| 指标 | 目标值 | 说明 |
|-----|-------|-----|
| 连接建立 | < 1s | WebSocket 握手完成 |
| 音频传输延迟 | < 50ms | 从采集到服务端接收 |
| 命令响应 | < 100ms | 从发送到收到响应 |
| 播放启动 | < 500ms | 从命令到开始播放 |
| 唤醒响应 | < 200ms | 从唤醒词到提示音 |

### 10.2 资源使用

```yaml
客户端资源:
  CPU: < 10% (空闲时)
  内存: < 50MB
  网络: < 100KB/s (音频传输时)

音频带宽:
  PCM 16kHz 16bit mono: 32 KB/s
  压缩后 (可选): 4-8 KB/s
```

---

## 11. 调试与测试

### 11.1 调试工具

```bash
# 1. 查看 WebSocket 连接
wscat -c ws://server:4399

# 2. 发送测试命令
{"id":"test-001","command":"get_play_status"}

# 3. 查看服务端日志
docker logs -f voicegrow-server

# 4. 监控设备连接
curl http://server:8000/api/devices
```

### 11.2 测试用例

```python
# test_client_protocol.py

async def test_kws_event():
    """测试唤醒词事件"""
    async with websockets.connect("ws://localhost:4399") as ws:
        # 发送唤醒词事件
        await ws.send(json.dumps({
            "id": "test-001",
            "event": "kws",
            "data": "小爱同学"
        }))

        # 等待响应
        response = await ws.recv()
        assert "play_url" in response or "play_text" in response

async def test_play_command():
    """测试播放命令"""
    async with websockets.connect("ws://localhost:4399") as ws:
        # 模拟服务端发送播放命令
        # 验证客户端正确响应
        pass
```

---

## 附录 A: open-xiaoai 项目参考

- **项目地址**: https://github.com/idootop/open-xiaoai
- **文档**: https://github.com/idootop/open-xiaoai/blob/main/README.md
- **示例代码**: https://github.com/idootop/open-xiaoai/tree/main/examples

## 附录 B: 设备适配说明

### 小爱音箱 Pro (LX06)

```yaml
型号: LX06
产品名: 小爱音箱 Pro
支持状态: 完全支持
特点:
  - 标准 open-xiaoai 协议
  - 高品质麦克风阵列
  - 良好的唤醒词识别
```

### Xiaomi Smart Speaker Pro (OH2P)

```yaml
型号: OH2P
产品名: Xiaomi Smart Speaker Pro
支持状态: 完全支持
特点:
  - 与 LX06 协议兼容
  - 海外版本
```

## 附录 C: 常见问题

### Q1: 客户端如何连接服务端？

配置 open-xiaoai 的服务端地址为 VoiceGrow 服务器的 IP 和端口 (4399)。

### Q2: 是否需要修改客户端代码？

不需要。直接使用 open-xiaoai 提供的功能即可。

### Q3: 如何处理网络断开？

open-xiaoai 内置了自动重连机制，会在网络恢复后自动重新连接。

### Q4: 支持多设备吗？

支持。每个设备使用唯一的 device_id 标识，服务端可以同时管理多个设备。
