# VoiceGrow VPS Nginx 配置
#
# 部署架构:
#   [小爱音箱] → 公网 → [VPS Nginx] → WireGuard → [内网服务器]
#
# 功能:
#   /audio/*  → 反代内网 MinIO + 缓存 (音频文件)
#   /ws       → 反代内网 VoiceGrow WebSocket (控制信令, HTTPS)
#   :14399    → 反代内网 WebSocket (非 TLS, 音箱客户端专用)
#
# 使用前替换:
#   YOUR_DOMAIN        → 你的 VPS 域名 (如 vps.example.com)
#   10.0.0.2           → 内网服务器的 WireGuard IP
#   SSL 证书路径        → Let's Encrypt 或自有证书
#
# 安装:
#   sudo cp voicegrow.conf /etc/nginx/sites-available/
#   sudo ln -s /etc/nginx/sites-available/voicegrow.conf /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx

# ========== 音频缓存配置 ==========
proxy_cache_path /var/cache/nginx/voicegrow_audio
    levels=1:2
    keys_zone=voicegrow_audio:10m
    max_size=1g
    inactive=7d
    use_temp_path=off;

# ========== Upstream 定义 ==========
upstream voicegrow_ws {
    server 172.16.0.2:18009;       # 内网 VoiceGrow WebSocket (via WireGuard)
}

upstream minio_server {
    server 172.16.0.2:11006;       # 内网 MinIO (via WireGuard)
}

# ========== HTTP → HTTPS 重定向 ==========
server {
    listen 80;
    server_name voicegrow.jin-gen.com;
    return 301 https://$host$request_uri;
}

# ========== 主配置 ==========
server {
    listen 443 ssl http2;
    server_name voicegrow.jin-gen.com;

    # --- SSL ---
    ssl_certificate     /etc/letsencrypt/live/voicegrow.jin-gen.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/voicegrow.jin-gen.com/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # --- 音频文件: 反代 MinIO + Nginx 缓存 ---
    #
    # URL 映射:
    #   https://YOUR_DOMAIN/audio/tts/abc123.mp3
    #   → http://10.0.0.2:9000/voicegrow/tts/abc123.mp3
    #
    # 首次请求穿隧道取文件，后续命中 Nginx 缓存直接返回
    location /audio/ {
        proxy_pass http://minio_server/voicegrow/;

        # 缓存策略
        proxy_cache voicegrow_audio;
        proxy_cache_valid 200 7d;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;                    # 并发请求同一资源时只穿透一次

        # 缓存键只用 URI，忽略 query string (TTS 文件按 hash 命名，无需参数)
        proxy_cache_key $uri;

        # 响应头
        add_header X-Cache-Status $upstream_cache_status always;
        add_header Cache-Control "public, max-age=604800" always;

        # MinIO 公开读取策略已设置，无需 Authorization
        # Host 必须传 MinIO 实际地址，否则 MinIO 路由异常
        proxy_set_header Host 10.0.0.2:9000;
    }

    # --- WebSocket: 控制信令转发 (HTTPS, 浏览器/支持 TLS 的客户端) ---
    location /ws {
        proxy_pass http://voicegrow_ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 长连接超时 (24小时)
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # --- 健康检查 ---
    location /health {
        return 200 'ok';
        add_header Content-Type text/plain;
    }
}

# ========== WebSocket 非 TLS（音箱客户端无 TLS 支持）==========
# open-xiaoai Rust 客户端的 tokio-tungstenite 未编译 TLS feature，
# 不支持 wss://，需通过非加密端口连接。
# 音箱连接地址: ws://YOUR_DOMAIN:14399
server {
    listen 14399;

    location / {
        proxy_pass http://voicegrow_ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
}
